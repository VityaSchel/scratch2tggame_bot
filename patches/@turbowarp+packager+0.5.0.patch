diff --git a/node_modules/@turbowarp/packager/.DS_Store b/node_modules/@turbowarp/packager/.DS_Store
new file mode 100644
index 0000000..fb60e75
Binary files /dev/null and b/node_modules/@turbowarp/packager/.DS_Store differ
diff --git a/node_modules/@turbowarp/packager/dist/packager.js b/node_modules/@turbowarp/packager/dist/packager.js
index 4676946..cec496c 100644
--- a/node_modules/@turbowarp/packager/dist/packager.js
+++ b/node_modules/@turbowarp/packager/dist/packager.js
@@ -1 +1 @@
-!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("cross-fetch"),require("jszip"),require("sha.js"),require("@fiahfy/icns")):"function"==typeof define&&define.amd?define(["cross-fetch","jszip","sha.js","@fiahfy/icns"],t):"object"==typeof exports?exports.packager=t(require("cross-fetch"),require("jszip"),require("sha.js"),require("@fiahfy/icns")):e.packager=t(e["cross-fetch"],e.jszip,e["sha.js"],e["@fiahfy/icns"])}(global,(function(e,t,n,s){return function(e){var t={},n={1:0};function s(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,s),o.l=!0,o.exports}return s.e=function(t){if(0!==n[t]){var s=require("./"+({0:"icns"}[t]||t)+".js"),o=s.modules,r=s.ids;for(var i in o)e[i]=o[i];for(var a=0;a<r.length;a++)n[r[a]]=0}return Promise.all([])},s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(n,o,function(t){return e[t]}.bind(null,o));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s.oe=function(e){process.nextTick((function(){throw e}))},s(s.s=8)}([function(e,t){e.exports={APP_NAME:"TurboWarp Packager",LONG_NAME:"TurboWarp Packager for Scratch",WEBSITE:"https://packager.turbowarp.org/",COPYRIGHT_NOTICE:"Copyright (C) 2021 Thomas Weber\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License version 3\nas published by the Free Software Foundation.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with this program. If not, see <https://www.gnu.org/licenses/>.",ACCENT_COLOR:"#ff4c4c",SOURCE_CODE:"https://github.com/TurboWarp/packager",FEEDBACK_PRIMARY:{name:"Scratch",link:"https://scratch.mit.edu/users/GarboMuffin/#comments"},FEEDBACK_SECONDARY:{name:"GitHub",link:"https://github.com/TurboWarp/packager/issues"}}},function(t,n){t.exports=e},function(e,t){e.exports=require("path")},function(e,n){e.exports=t},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("util")},function(e,t){e.exports=n},function(e){e.exports=JSON.parse('{"a":"@turbowarp/packager"}')},function(e,t,n){"use strict";n.r(t),n.d(t,"Packager",(function(){return L})),n.d(t,"loadProject",(function(){return q}));var s={};n.r(s),n.d(s,"sha256",(function(){return c}));class o{constructor(){this._events={}}addEventListener(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t)}removeEventListener(e,t){const n=this._events[e];n&&(this._events[e]=n.filter(e=>e!==t))}dispatchEvent(e){const t=this._events[e.type];if(t)for(const n of t)n(e)}}class r{constructor(e,{detail:t}){this.type=e,this.detail=t}}var i=n(6),a=n.n(i);const c=e=>a()("sha256").update(new Uint8Array(e)).digest("hex");var l=()=>({worker:s,terminate:()=>{}});var d=e=>e.replace(/["'<>&]/g,e=>{switch(e){case'"':return"&quot;";case"'":return"&apos;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;"}});const p="https://packagerdata.turbowarp.org/";var u={"nwjs-win64":{src:p+"nwjs-v0.54.0-win-x64.zip",sha256:"0f082671b67b711f783d98cc989cf5aebacfc9bce3bef78875b57d08fc2a6e86",type:"arraybuffer"},"nwjs-win32":{src:p+"nwjs-v0.54.0-win-ia32.zip",sha256:"7a1ed3a6a51b8cdf9280761b90cb4723cf9ee8050e3ed0b58451e8e4e694b203",type:"arraybuffer"},"nwjs-mac":{src:p+"nwjs-v0.54.0-osx-x64.zip",sha256:"498c97a264f8feac504c4c2396c1fddc8290c15573aee2fc692e59ff9803cc40",type:"arraybuffer"},"nwjs-linux-x64":{src:p+"nwjs-v0.54.0-linux-x64.zip",sha256:"53651a3a12d29ad096cff5b44d9f1e3aa09e9fad970bdcfe8bda07ea23d960d8",type:"arraybuffer"},"electron-win32":{src:p+"electron-v15.0.0-win32-ia32.zip",sha256:"5b69112b91010d78abf6012f387ea3fe5c0e36657c5f386a4c2bb42138aa1a8e",type:"arraybuffer"},"electron-win64":{src:p+"electron-v15.0.0-win32-x64.zip",sha256:"3d95422d9f2fccb07b745b31007548231d80ff63e3640f49a5f8591498a3afa2",type:"arraybuffer"},"electron-linux64":{src:p+"electron-v15.1.1-linux-x64.zip",sha256:"70de2da51c6a8591b88f08366c82166a51b1719243f67ef1a14eddbb806a115f",type:"arraybuffer"},"webview-mac":{src:p+"WebView-macos-3.zip",sha256:"5d4086894f10549c61c20e5f770c808afc25c2e4793da75b5b1cede294449fac",type:"arraybuffer"},scaffolding:{src:"scaffolding/scaffolding.js",estimatedSize:4775503,useBuildId:!0,type:"text"},"scaffolding-min":{src:"scaffolding/scaffolding-min.js",estimatedSize:2540321,useBuildId:!0,type:"text"},addons:{src:"scaffolding/addons.js",estimatedSize:14339,useBuildId:!0,type:"text"}};const f=e=>Math.max(0,Math.min(1,e));var h=({url:e,type:t,progressCallback:n,timeout:s,estimatedSize:o,abortTarget:r})=>new Promise((i,a)=>{const c=new XMLHttpRequest;c.onload=()=>{l(),200===c.status?i(c.response):a(new Error("Request failed with status code: "+c.status))},c.onerror=()=>{l(),a(new Error("Request failed, are you offline?"))},n&&(c.onprogress=e=>{e.lengthComputable?n(f(e.loaded/e.total)):o&&n(f(e.loaded/o))}),c.responseType=t,c.open("GET",e),c.send();const l=()=>{d&&d(),p&&clearTimeout(p)};let d,p;if(r){const e=()=>{c.abort(),l(),a(new Error("Request aborted"))};r.addEventListener("abort",e),d=()=>{r.removeEventListener("abort",e)}}s&&(p=setTimeout(()=>{c.abort(),l(),a(new Error("Request timed out"))},s))});const g=e=>new Promise((t,n)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>n(new Error("Cannot read as array buffer: "+s.error)),s.readAsArrayBuffer(e)}),m=e=>new Promise((t,n)=>{e.toBlob(e=>{e?t(e):n(new Error("Could not read <canvas> as blob"))})});var w=async e=>{const{Icns:t,Buffer:s}=await n.e(0).then(n.bind(null,11)),o=new Blob([e],{type:"image/png"}),r=URL.createObjectURL(o),i=await(a=r,new Promise((e,t)=>{const n=new Image;n.onload=()=>e(n),n.onerror=()=>t(new Error("Could not load image: "+a)),n.src=a}));var a;const c=[{type:"ic04",size:16},{type:"ic07",size:128},{type:"ic08",size:256},{type:"ic09",size:512},{type:"ic10",size:1024},{type:"ic11",size:32},{type:"ic12",size:64},{type:"ic13",size:256},{type:"ic14",size:512}].filter(e=>16===e.size||i.width>=e.size&&i.height>=e.size),l=document.createElement("canvas"),d=l.getContext("2d");if(!d)throw new Error("cannot get canvas rendering context");const p=new t.Icns;for(const e of c){const n=e.size;l.width=n,l.height=n,d.drawImage(i,0,0,n,n);const o=await m(l),r=await g(o),a=await t.IcnsImage.fromPNG(s.from(r),e.type);p.append(a)}return p.data};const b="811095aaf2285f384fcdcbdd901b356eb3202005e490c913b0b79a56185ce270",y=e=>{const t=e=>(40===e&&(e=60),41===e&&(e=62),e-42),n=e.indexOf(","),s=+e.substring(0,n).split("").map(e=>String.fromCharCode(e.charCodeAt(0)-49)).join(""),o=new ArrayBuffer((r=s)%4==0?r:r+(4-r%4));var r;const i=new Uint32Array(o);for(let s=n+1,o=0;s<e.length;s+=5,o++)i[o]=85*t(e.charCodeAt(s+4))*85*85*85+85*t(e.charCodeAt(s+3))*85*85+85*t(e.charCodeAt(s+2))*85+85*t(e.charCodeAt(s+1))+t(e.charCodeAt(s));return new Uint8Array(o,0,s)},v=e=>{if("dict"===e.tagName){const t={};for(const n of e.children)"key"===n.tagName&&(t[n.textContent]=v(n.nextElementSibling));return t}return"array"===e.tagName?Array.from(e.children).map(v):"string"===e.tagName?e.textContent:(console.warn("unknown plist xml",e),null)},E=(e,t)=>{if(Array.isArray(t)){const n=e.createElement("array");for(const s of t)n.appendChild(E(e,s));return n}if("object"==typeof t){const n=e.createElement("dict");for(const[s,o]of Object.entries(t)){const t=e.createElement("key");t.textContent=s;const r=E(e,o);n.appendChild(t),n.appendChild(r)}return n}if("string"==typeof t){const n=e.createElement("string");return n.textContent=t,n}return console.warn("unknown plist value",t),E(e,""+t)};var S=n(0);const A=async()=>(await Promise.resolve().then(n.t.bind(null,3,7))).default,I=(e,t,n)=>{e.files[t]=n},O={title:S.APP_NAME,homepage:S.WEBSITE,license:S.COPYRIGHT_NOTICE},T={title:"Scratch",homepage:"https://scratch.mit.edu/",license:'Copyright (c) 2016, Massachusetts Institute of Technology\nAll rights reserved.\n\nRedistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n\n1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n\n2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n\n3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.'},x={title:"Electron",homepage:"https://www.electronjs.org/",license:'Copyright (c) Electron contributors\nCopyright (c) 2013-2020 GitHub Inc.\n\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n"Software"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\nOF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\nWITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.'},N=`/*!\nParts of this script are from the ${S.APP_NAME} <${S.WEBSITE}>, licensed as follows:\n${O.license}\n\nParts of this script are from Scratch <https://scratch.mit.edu/>, licensed as follows:\n${T.license}\n*/\n`,R=e=>`<style>body { font-family: sans-serif; }</style>${`<h2>The following entries were added by the ${S.APP_NAME}</h2>`}${e.map(({title:e,license:t,homepage:n},s)=>`\n<div class="product">\n<span class="title">${d(e)}</span>\n<span class="homepage"><a href="${d(n)}">homepage</a></span>\n<input type="checkbox" hidden id="p4-${s}">\n<label class="show" for="p4-${s}" tabindex="0"></label>\n<div class="licence">\n<pre>${d(t)}</pre>\n</div>\n</div>\n`).join("\n")}`;class C extends o{constructor(){super(),this.project=null,this.options=C.DEFAULT_OPTIONS(),this.aborted=!1,this.used=!1}abort(){this.aborted||(this.aborted=!0,this.dispatchEvent(new Event("abort")))}ensureNotAborted(){if(this.aborted)throw new Error("Aborted")}async fetchLargeAsset(e){this.ensureNotAborted();const t=u[e];if(!t)throw new Error("Invalid asset: "+e);if("undefined"!=typeof __ASSETS__&&__ASSETS__[t.src])return __ASSETS__[t.src];const n=t=>this.dispatchEvent(new r("large-asset-fetch",{detail:{asset:e,progress:t}}));let s;n(0);let o=!1;try{const e=await C.adapter.getCachedAsset(t);e&&(s=e,o=!0,n(.5))}catch(e){console.warn(e)}if(!s){let e=t.src;t.useBuildId&&(e+="?"+b),s=await h({url:e,type:t.type,estimatedSize:t.estimatedSize,progressCallback:e=>{n(e)},abortTarget:this})}if(t.useBuildId&&(i=b,(a=s).endsWith("=^..^=")&&!a.endsWith(i+" =^..^=")))throw new Error("Build ID mismatch; This should be fixed after refreshing the page.");var i,a;if(t.sha256){const n=await(async e=>{const{worker:t,terminate:n}=l(),s=await t.sha256(e);return n(),s})(s);if(n!==t.sha256)throw new Error(`Hash mismatch for ${e}, found ${n} but expected ${t.sha256}`)}if(!o)try{await C.adapter.cacheAsset(t,s)}catch(e){console.warn(e)}return n(1),s}getAddonOptions(){return{...this.options.chunks,specialCloudBehaviors:this.options.cloudVariables.specialCloudBehaviors,unsafeCloudBehaviors:this.options.cloudVariables.unsafeCloudBehaviors,pause:this.options.controls.pause.enabled}}async loadResources(){const e=[N];this.project.analysis.usesMusic?e.push(await this.fetchLargeAsset("scaffolding")):e.push(await this.fetchLargeAsset("scaffolding-min")),Object.values(this.getAddonOptions()).some(e=>e)&&e.push(await this.fetchLargeAsset("addons")),this.script=e.join("\n").replace(/<\/script>/g,"</scri'+'pt>")}computeWindowSize(){let e=this.options.stageWidth,t=this.options.stageHeight;return(this.options.controls.greenFlag.enabled||this.options.controls.stopAll.enabled||this.options.controls.pause.enabled)&&(t+=48),{width:e,height:t}}async addNwJS(e){const t=await this.fetchLargeAsset(this.options.target),n=await(await A()).loadAsync(t),s=this.options.target.startsWith("nwjs-win"),o="nwjs-mac"===this.options.target,r=this.options.target.startsWith("nwjs-linux"),i=Object.keys(n.files)[0].split("/")[0],a=new(await A()),c=this.options.app.packageName;for(const e of Object.keys(n.files)){const t=n.files[e];let l=e.replace(i,c);s?l=l.replace("nw.exe",c+".exe"):o?l=l.replace("nwjs.app",c+".app"):r&&(l=l.replace(/nw$/,c)),I(a,l,t)}const l=await C.adapter.getAppIcon(this.options.app.icon),d={name:c,main:"main.js",window:{width:this.computeWindowSize().width,height:this.computeWindowSize().height,icon:"icon.png"}};let p;if(s)p=c+"/";else if(o){const e=await w(l);a.file(`${c}/${c}.app/Contents/Resources/app.icns`,e),p=`${c}/${c}.app/Contents/Resources/app.nw/`}else if(r){const e='#!/bin/bash\ncd "$(dirname "$0")"\n./'+c;a.file(c+"/start.sh",e,{unixPermissions:33261}),p=c+"/"}for(const t of Object.keys(e.files))I(a,p+t,e.files[t]);a.file(p+"icon.png",l),a.file(p+"package.json",JSON.stringify(d,null,4)),a.file(p+"main.js","\n    const start = () => nw.Window.open('index.html', {\n      position: 'center',\n      new_instance: true\n    });\n    nw.App.on('open', start);\n    start();");const u=c+"/credits.html",f=await a.file(u).async("string");return a.file(u,f+R([O,T])),a}async addElectron(e){const t=await this.fetchLargeAsset(this.options.target),n=await(await A()).loadAsync(t),s=this.options.target.includes("win"),o=this.options.target.includes("linux"),r=new(await A()),i=this.options.app.packageName;for(const e of Object.keys(n.files)){const t=n.files[e];let a=`${i}/${e}`;s?a=a.replace("electron.exe",i+".exe"):o&&(a=a.replace(/electron$/,i)),I(r,a,t)}const a=await r.file(i+"/LICENSES.chromium.html").async("string");r.file(i+"/licenses.html",a+R([O,T,x])),r.remove(i+"/LICENSE.txt"),r.remove(i+"/LICENSES.chromium.html"),r.remove(i+"/LICENSE"),r.remove(i+"/version"),r.remove(i+"/resources/default_app.asar");const c=i+"/",l=c+"resources/app/",d=await C.adapter.getAppIcon(this.options.app.icon);r.file(l+"icon.png",d);const p={name:i,main:"electron-main.js"};r.file(l+"package.json",JSON.stringify(p));const u=`'use strict';\nconst {app, BrowserWindow, Menu, shell, screen} = require('electron');\nconst path = require('path');\n\nconst isWindows = process.platform === 'win32';\nconst isMac = process.platform === 'darwin';\nconst isLinux = process.platform === 'linux';\n\nif (isMac) {\n  // TODO\n  Menu.setApplicationMenu(Menu.buildFromTemplate([\n    { role: 'appMenu' },\n    { role: 'fileMenu' },\n    { role: 'editMenu' },\n    { role: 'viewMenu' },\n    { role: 'windowMenu' },\n    { role: 'help' }\n  ]));\n} else {\n  Menu.setApplicationMenu(null);\n}\n\napp.enableSandbox();\n\nconst createWindow = (windowOptions) => {\n  const options = {\n    title: ${JSON.stringify(this.options.app.windowTitle)},\n    icon: path.resolve(__dirname, ${JSON.stringify("icon.png")}),\n    useContentSize: true,\n    webPreferences: {\n      contextIsolation: true,\n      nodeIntegration: false,\n    },\n    show: true,\n    width: 480,\n    height: 360,\n    ...windowOptions,\n  };\n\n  const activeScreen = screen.getDisplayNearestPoint(screen.getCursorScreenPoint());\n  const bounds = activeScreen.workArea;\n  options.x = bounds.x + ((bounds.width - options.width) / 2);\n  options.y = bounds.y + ((bounds.height - options.height) / 2);\n\n  const window = new BrowserWindow(options);\n  return window;\n};\n\nconst createProjectWindow = () => {\n  const windowMode = ${JSON.stringify(this.options.app.windowMode)};\n  const window = createWindow({\n    show: false,\n    backgroundColor: ${JSON.stringify(this.options.appearance.background)},\n    width: ${this.computeWindowSize().width},\n    height: ${this.computeWindowSize().height},\n    minWidth: 50,\n    minHeight: 50,\n    fullscreen: windowMode === 'fullscreen',\n  });\n  if (windowMode === 'maximize') {\n    window.maximize();\n  }\n  window.loadFile(path.resolve(__dirname, './index.html'));\n  window.show();\n};\n\nconst createDataWindow = (dataURI) => {\n  const window = createWindow({});\n  window.loadURL(dataURI);\n};\n\nconst isSafeOpenExternal = (url) => {\n  try {\n    const parsedUrl = new URL(url);\n    return parsedUrl.protocol === 'https:' || parsedUrl.protocol === 'http:';\n  } catch (e) {\n    // ignore\n  }\n  return false;\n};\n\nconst isDataURL = (url) => {\n  try {\n    const parsedUrl = new URL(url);\n    return parsedUrl.protocol === 'data:';\n  } catch (e) {\n    // ignore\n  }\n  return false;\n};\n\nconst openLink = (url) => {\n  if (isSafeOpenExternal(url)) {\n    shell.openExternal(url);\n  } else if (isDataURL(url)) {\n    createDataWindow(url);\n  }\n};\n\napp.on('web-contents-created', (event, contents) => {\n  contents.setWindowOpenHandler((details) => {\n    setImmediate(() => {\n      openLink(details.url);\n    });\n    return {action: 'deny'};\n  });\n  contents.on('will-navigate', (e, url) => {\n    e.preventDefault();\n    openLink(url);\n  });\n  contents.on('before-input-event', (e, input) => {\n    const window = BrowserWindow.fromWebContents(contents);\n    if (!window || input.type !== "keyDown") return;\n    if (input.key === 'F11' || (input.key === 'Enter' && input.alt)) {\n      window.setFullScreen(!window.isFullScreen());\n    } else if (input.key === 'Escape' && window.isFullScreen()) {\n      window.setFullScreen(false);\n    }\n  });\n});\n\napp.on('window-all-closed', () => {\n  app.quit();\n});\n\napp.whenReady().then(() => {\n  createProjectWindow();\n  app.on('activate', () => {\n    if (BrowserWindow.getAllWindows().length === 0) {\n      createProjectWindow();\n    }\n  });\n});\n`;r.file(l+"electron-main.js",u);for(const[t,n]of Object.entries(e.files))I(r,`${l}${t}`,n);if(s){const e=`Open "${i}.exe" to start the app. Open "licenses.html" for information regarding software licenses used by the app.`;r.file(c+"README.txt",e)}else if(o){const e='#!/bin/bash\ncd "$(dirname "$0")"\n./'+i;r.file(c+"start.sh",e,{unixPermissions:33261})}return r}async addWebViewMac(e){const t=await this.fetchLargeAsset(this.options.target),n=await(await A()).loadAsync(t),s=this.options.app.packageName+".app",o=s+"/Contents/",r=s+"/Contents/Resources/",i=new(await A());for(const[e,t]of Object.entries(n.files)){const n=e.replace("WebView.app",s).replace(/WebView$/,this.options.app.packageName);I(i,n,t)}for(const[t,n]of Object.entries(e.files))I(i,`${r}${t}`,n);const a=await C.adapter.getAppIcon(this.options.app.icon),c=await w(a);i.file(r+"AppIcon.icns",c),i.remove(r+"Assets.car");const l=parseInt(this.options.appearance.background.substr(1),16),d={title:this.options.app.windowTitle,background:[l>>16&255,l>>8&255,255&l,1],width:this.computeWindowSize().width,height:this.computeWindowSize().height};i.file(r+"application_config.json",JSON.stringify(d));const p=(e=>{const t=(new DOMParser).parseFromString(e,"text/xml").children[0].children[0];return v(t)})(await i.file(o+"Info.plist").async("string"));return p.CFBundleIdentifier="org.turbowarp.packager.userland."+this.options.app.packageName,p.CFBundleName=this.options.app.windowTitle,p.CFBundleExecutable=this.options.app.packageName,i.file(o+"Info.plist",(e=>{const t=document.implementation.createDocument(null,"plist"),n=t.documentElement;n.setAttribute("version","1.0"),n.appendChild(E(t,e));return'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n'+(new XMLSerializer).serializeToString(t)})(p)),i}makeWebSocketProvider(){const e="wss://clouddata.turbowarp.org"===this.options.cloudVariables.cloudHost?["wss://clouddata.turbowarp.org","wss://clouddata.turbowarp.xyz"]:this.options.cloudVariables.cloudHost;return`new Scaffolding.Cloud.WebSocketProvider(${JSON.stringify(e)}, ${JSON.stringify(this.options.projectId)})`}makeLocalStorageProvider(){return`new Scaffolding.Cloud.LocalStorageProvider(${JSON.stringify("cloudvariables:"+this.options.projectId)})`}makeCustomProvider(){const e=this.options.cloudVariables.custom;let t="{const providers = {};\n";for(const n of new Set(Object.values(e)))"ws"===n?t+=`providers.ws = ${this.makeWebSocketProvider()};\n`:"local"===n&&(t+=`providers.local = ${this.makeLocalStorageProvider()};\n`);t+="for (const provider of Object.values(providers)) scaffolding.addCloudProvider(provider);\n";for(const n of Object.keys(e)){const s=e[n];t+=`scaffolding.addCloudProviderOverride(${JSON.stringify(n)}, providers[${JSON.stringify(s)}] || null);\n`}return t+="}",t}generateFilename(e){return`${this.options.app.windowTitle}.${e}`}async generateGetProjectData(){let e,t,n="",s="",o=!1;if("html"===this.options.target){o="blob"!==this.project.type,e=.75,t=.98;const c=1e5,l=(e=>{const t=e.byteLength;let n;if(t%4!=0){const s=new ArrayBuffer(t+(4-t%4)),o=new Uint8Array(e),r=new Uint8Array(s);for(let e=0;e<o.length;e++)r[e]=o[e];n=new Uint32Array(s)}else n=new Uint32Array(e);const s=t.toString(),o=new ArrayBuffer(s.length+1+5*n.byteLength/4),r=new Uint8Array(o);let i=0;for(let e=0;e<s.length;e++)r[i++]=s.charCodeAt(e)+49;r[i++]=44;const a=e=>60===(e+=42)?40:62===e?41:e;for(let e=0;e<n.length;e++){let t=n[e];r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85)}return(new TextDecoder).decode(o)})(this.project.arrayBuffer);for(let e=0;e<l.length;e+=c){n+=`<script type="p4-project">${l.substr(e,c)}<\/script><script>setProgress(${(r=.1,i=.75,a=e/l.length,r+a*(i-r)).toString().substr(1,4)})<\/script>`}s=`async () => {\n        const base85decode = ${y};\n        const dataElements = Array.from(document.querySelectorAll('script[type="p4-project"]'));\n        const result = base85decode(dataElements.map(i => i.textContent).join(''));\n        dataElements.forEach(i => i.remove());\n        return result;\n      }`}else{let n;"blob"===this.project.type||"zip-one-asset"===this.options.target?(o="blob"!==this.project.type,n="./project.zip",e=.75,t=.98):(n="./assets/project.json",e=.2,t=.98),s=`() => new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        xhr.onload = () => {\n          resolve(xhr.response);\n        };\n        xhr.onerror = () => {\n          if (location.protocol === 'file:') {\n            reject(new Error('Zip environment must be used from a website, not from a file URL.'));\n          } else {\n            reject(new Error('Request to load project data failed.'));\n          }\n        };\n        xhr.onprogress = (e) => {\n          if (e.lengthComputable) {\n            setProgress(interpolate(0.1, ${e}, e.loaded / e.total));\n          }\n        };\n        xhr.responseType = 'arraybuffer';\n        xhr.open('GET', ${JSON.stringify(n)});\n        xhr.send();\n      })`}var r,i,a;return n+=`\n    <script>\n      const getProjectData = (function() {\n        const storage = scaffolding.storage;\n        storage.onprogress = (total, loaded) => {\n          setProgress(interpolate(${e}, ${t}, loaded / total));\n        };\n        ${o?`\n        storage.addHelper({\n          load: (assetType, assetId, dataFormat) => zip.file(assetId + '.' + dataFormat)\n            .async('uint8array')\n            .then((data) => new storage.Asset(assetType, assetId, dataFormat, data))\n        });\n        return () => (${s})().then(async (data) => {\n          zip = await Scaffolding.JSZip.loadAsync(data);\n          return zip.file('project.json').async('arraybuffer');\n        });`:`\n        storage.addWebStore(\n          [storage.AssetType.ImageVector, storage.AssetType.ImageBitmap, storage.AssetType.Sound],\n          (asset) => new URL('./assets/' + asset.assetId + '.' + asset.dataFormat, location).href\n        );\n        return ${s};`}\n      })();\n    <\/script>`,n}async generateFavicon(){if(null===this.options.app.icon)return"";return`<link rel="icon" href="${await C.adapter.readAsURL(this.options.app.icon,"app icon")}">`}async generateCursor(){if("custom"!==this.options.cursor.type)return this.options.cursor.type;if(!this.options.cursor.custom)return"auto";return`url(${await C.adapter.readAsURL(this.options.cursor.custom,"custom cursor")}), auto`}async package(){if(!C.adapter)throw new Error("Missing adapter");if(this.used)throw new Error("Packager was already used");this.used=!0,this.ensureNotAborted(),await this.loadResources(),this.ensureNotAborted();const e=`<!DOCTYPE html>\n\x3c!-- Created with ${S.WEBSITE} --\x3e\n<html>\n<head>\n  <meta charset="utf-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">\n  \x3c!-- We only include this to explicitly loosen the CSP of various packager environments. It does not provide any security. --\x3e\n  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:">\n  <title>${d(this.options.app.windowTitle)}</title>\n  <style>\n    body {\n      color: ${this.options.appearance.foreground};\n      font-family: sans-serif;\n      overflow: hidden;\n      margin: 0;\n      padding: 0;\n    }\n    :root, body.is-fullscreen {\n      background-color: ${this.options.appearance.background};\n    }\n    [hidden] {\n      display: none !important;\n    }\n    h1 {\n      font-weight: normal;\n    }\n    a {\n      color: inherit;\n      text-decoration: underline;\n      cursor: pointer;\n    }\n\n    #app, #loading, #error, #launch {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n    }\n    .screen {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      text-align: center;\n      cursor: default;\n      user-select: none;\n      -webkit-user-select: none;\n      background-color: ${this.options.appearance.background};\n    }\n    #launch {\n      background-color: rgba(0, 0, 0, 0.7);\n      cursor: pointer;\n    }\n    .green-flag {\n      width: 80px;\n      height: 80px;\n      padding: 16px;\n      border-radius: 100%;\n      background: rgba(255, 255, 255, 0.75);\n      border: 3px solid hsla(0, 100%, 100%, 1);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      box-sizing: border-box;\n    }\n    #loading {\n      ${this.options.loadingScreen.image&&"stretch"===this.options.loadingScreen.imageMode?`background-image: url(${await C.adapter.readAsURL(this.options.loadingScreen.image,"stretched loading screen")});\n      background-repeat: no-repeat;\n      background-size: contain;\n      background-position: center;`:""}\n    }\n    .progress-bar-outer {\n      border: 1px solid currentColor;\n      height: 10px;\n      width: 200px;\n      max-width: 200px;\n    }\n    .progress-bar-inner {\n      height: 100%;\n      width: 0;\n      background-color: currentColor;\n    }\n    .loading-text {\n      font-weight: normal;\n      font-size: 36px;\n      margin: 0 0 16px;\n    }\n    .loading-image {\n      margin: 0 0 16px;\n    }\n    #error-message, #error-stack {\n      font-family: monospace;\n      max-width: 600px;\n      white-space: pre-wrap;\n      user-select: text;\n      -webkit-user-select: text;\n    }\n    #error-stack {\n      text-align: left;\n      max-height: 200px;\n      overflow: auto;\n    }\n    .control-button {\n      width: 2rem;\n      height: 2rem;\n      padding: 0.375rem;\n      border-radius: 0.25rem;\n      margin-top: 0.5rem;\n      margin-bottom: 0.5rem;\n      user-select: none;\n      -webkit-user-select: none;\n      cursor: pointer;\n      border: 0;\n      border-radius: 4px;\n    }\n    .control-button:hover {\n      background: ${this.options.appearance.accent}26;\n    }\n    .control-button.active {\n      background: ${this.options.appearance.accent}59;\n    }\n    .fullscreen-button {\n      background: white !important;\n    }\n    .standalone-fullscreen-button {\n      position: absolute;\n      top: 0;\n      right: 0;\n      background-color: rgba(0, 0, 0, 0.5);\n      border-radius: 0 0 0 4px;\n      padding: 4px;\n      cursor: pointer;\n    }\n    .sc-canvas {\n      cursor: ${await this.generateCursor()};\n    }\n    ${this.options.custom.css}\n  </style>\n  <meta name="theme-color" content="${this.options.appearance.background}">\n  ${await this.generateFavicon()}\n</head>\n<body>\n  <noscript>Enable JavaScript</noscript>\n\n  <div id="app"></div>\n\n  <div id="launch" class="screen" hidden title="Click to start">\n    <div class="green-flag">\n      <svg viewBox="0 0 16.63 17.5" width="42" height="44">\n        <defs><style>.cls-1,.cls-2{fill:#4cbf56;stroke:#45993d;stroke-linecap:round;stroke-linejoin:round;}.cls-2{stroke-width:1.5px;}</style></defs>\n        <path class="cls-1" d="M.75,2A6.44,6.44,0,0,1,8.44,2h0a6.44,6.44,0,0,0,7.69,0V12.4a6.44,6.44,0,0,1-7.69,0h0a6.44,6.44,0,0,0-7.69,0"/>\n        <line class="cls-2" x1="0.75" y1="16.75" x2="0.75" y2="0.75"/>\n      </svg>\n    </div>\n  </div>\n\n  <div id="loading" class="screen">\n    ${this.options.loadingScreen.text?`<h1 class="loading-text">${d(this.options.loadingScreen.text)}</h1>`:""}\n    ${this.options.loadingScreen.image&&"normal"===this.options.loadingScreen.imageMode?`<div class="loading-image"><img src="${await C.adapter.readAsURL(this.options.loadingScreen.image,"loading-screen")}"></div>`:""}\n    ${this.options.loadingScreen.progressBar?'<div class="progress-bar-outer"><div class="progress-bar-inner" id="loading-inner"></div></div>':""}\n  </div>\n\n  <div id="error" class="screen" hidden>\n    <h1>Error</h1>\n    <details>\n      <summary id="error-message"></summary>\n      <p id="error-stack"></p>\n    </details>\n  </div>\n\n  ${"html"===this.options.target?`<script>${this.script}<\/script>`:'<script src="script.js"><\/script>'}\n  <script>${t=`\n    const appElement = document.getElementById('app');\n    const launchScreen = document.getElementById('launch');\n    const loadingScreen = document.getElementById('loading');\n    const loadingInner = document.getElementById('loading-inner');\n    const errorScreen = document.getElementById('error');\n    const errorScreenMessage = document.getElementById('error-message');\n    const errorScreenStack = document.getElementById('error-stack');\n\n    const handleError = (error) => {\n      console.error(error);\n      if (!errorScreen.hidden) return;\n      errorScreen.hidden = false;\n      errorScreenMessage.textContent = '' + error;\n      let debug = error && error.stack || 'no stack';\n      debug += '\\nUser agent: ' + navigator.userAgent;\n      errorScreenStack.textContent = debug;\n    };\n    const setProgress = (progress) => {\n      if (loadingInner) loadingInner.style.width = progress * 100 + '%';\n    };\n    const interpolate = (a, b, t) => a + t * (b - a);\n\n    try {\n      setProgress(0.1);\n\n      const scaffolding = new Scaffolding.Scaffolding();\n      scaffolding.width = ${this.options.stageWidth};\n      scaffolding.height = ${this.options.stageHeight};\n      scaffolding.resizeMode = ${JSON.stringify(this.options.resizeMode)};\n      scaffolding.editableLists = ${this.options.monitors.editableLists};\n      scaffolding.setup();\n      scaffolding.appendTo(appElement);\n\n      const vm = scaffolding.vm;\n      window.scaffolding = scaffolding;\n      window.vm = scaffolding.vm;\n      window.Scratch = {\n        vm,\n        renderer: vm.renderer,\n        audioEngine: vm.runtime.audioEngine,\n        bitmapAdapter: vm.runtime.v2BitmapAdapter,\n        videoProvider: vm.runtime.ioDevices.video.provider\n      };\n\n      scaffolding.setUsername(${JSON.stringify(this.options.username)}.replace(/#/g, () => Math.floor(Math.random() * 10)));\n      scaffolding.setAccentColor(${JSON.stringify(this.options.appearance.accent)});\n\n      ${"ws"===this.options.cloudVariables.mode?`scaffolding.addCloudProvider(${this.makeWebSocketProvider()})`:"local"===this.options.cloudVariables.mode?`scaffolding.addCloudProvider(${this.makeLocalStorageProvider()})`:"custom"===this.options.cloudVariables.mode?this.makeCustomProvider():""};\n\n      ${this.options.controls.greenFlag.enabled?'\n      const greenFlagButton = document.createElement(\'img\');\n      greenFlagButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16.63 17.5"><path d="M.75 2a6.44 6.44 0 017.69 0h0a6.44 6.44 0 007.69 0v10.4a6.44 6.44 0 01-7.69 0h0a6.44 6.44 0 00-7.69 0" fill="#4cbf56" stroke="#45993d" stroke-linecap="round" stroke-linejoin="round"/><path stroke-width="1.5" fill="#4cbf56" stroke="#45993d" stroke-linecap="round" stroke-linejoin="round" d="M.75 16.75v-16"/></svg>\');\n      greenFlagButton.className = \'control-button\';\n      greenFlagButton.addEventListener(\'click\', () => {\n        scaffolding.greenFlag();\n      });\n      scaffolding.addEventListener(\'PROJECT_RUN_START\', () => {\n        greenFlagButton.classList.add(\'active\');\n      });\n      scaffolding.addEventListener(\'PROJECT_RUN_STOP\', () => {\n        greenFlagButton.classList.remove(\'active\');\n      });\n      scaffolding.addControlButton({\n        element: greenFlagButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.pause.enabled?'\n      const pauseButton = document.createElement(\'img\');\n      pauseButton.className = \'control-button\';\n      let isPaused = false;\n      pauseButton.addEventListener(\'click\', () => {\n        isPaused = !isPaused;\n        vm.setPaused(isPaused);\n      });\n      const updatePause = () => {\n        if (isPaused) {\n          pauseButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg width="16" height="16" viewBox="0 0 4.2333332 4.2333335" xmlns="http://www.w3.org/2000/svg"><path d="m3.95163484 2.02835365-1.66643921.9621191-1.66643913.96211911V.10411543l1.66643922.9621191z" fill="#ffae00"/></svg>\');\n        } else {\n          pauseButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg width="16" height="16" viewBox="0 0 4.2333332 4.2333335" xmlns="http://www.w3.org/2000/svg"><g fill="#ffae00"><path d="M.389.19239126h1.2631972v3.8485508H.389zM2.5810001.19239126h1.2631972v3.8485508H2.5810001z"/></g></svg>\');\n        }\n      }\n      vm.on(\'P4_PAUSE\', updatePause);\n      updatePause();\n      scaffolding.addControlButton({\n        element: pauseButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.stopAll.enabled?'\n      const stopAllButton = document.createElement(\'img\');\n      stopAllButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14"><path fill="#ec5959" stroke="#b84848" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M4.3.5h5.4l3.8 3.8v5.4l-3.8 3.8H4.3L.5 9.7V4.3z"/></svg>\');\n      stopAllButton.className = \'control-button\';\n      stopAllButton.addEventListener(\'click\', () => {\n        scaffolding.stopAll();\n      });\n      scaffolding.addControlButton({\n        element: stopAllButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.fullscreen.enabled?`\n      if (document.fullscreenEnabled || document.webkitFullscreenEnabled) {\n        let isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);\n        const fullscreenButton = document.createElement('img');\n        fullscreenButton.className = 'control-button fullscreen-button';\n        fullscreenButton.addEventListener('click', () => {\n          if (isFullScreen) {\n            if (document.exitFullscreen) {\n              document.exitFullscreen();\n            } else if (document.webkitExitFullscreen) {\n              document.webkitExitFullscreen();\n            }\n          } else {\n            if (document.body.requestFullscreen) {\n              document.body.requestFullscreen();\n            } else if (document.body.webkitRequestFullscreen) {\n              document.body.webkitRequestFullscreen();\n            }\n          }\n        });\n        const otherControlsExist = ${this.options.controls.greenFlag.enabled||this.options.controls.stopAll.enabled};\n        const fillColor = otherControlsExist ? '#575E75' : '${this.options.appearance.foreground}';\n        const updateFullScreen = () => {\n          isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);\n          document.body.classList.toggle('is-fullscreen', isFullScreen);\n          if (isFullScreen) {\n            fullscreenButton.src = 'data:image/svg+xml,' + encodeURIComponent('<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g fill="' + fillColor + '" fill-rule="evenodd"><path d="M12.662 3.65l.89.891 3.133-2.374a.815.815 0 011.15.165.819.819 0 010 .986L15.467 6.46l.867.871c.25.25.072.664-.269.664L12.388 8A.397.397 0 0112 7.611V3.92c0-.341.418-.514.662-.27M7.338 16.35l-.89-.89-3.133 2.374a.817.817 0 01-1.15-.166.819.819 0 010-.985l2.37-3.143-.87-.871a.387.387 0 01.27-.664L7.612 12a.397.397 0 01.388.389v3.692a.387.387 0 01-.662.27M7.338 3.65l-.89.891-3.133-2.374a.815.815 0 00-1.15.165.819.819 0 000 .986l2.37 3.142-.87.871a.387.387 0 00.27.664L7.612 8A.397.397 0 008 7.611V3.92a.387.387 0 00-.662-.27M12.662 16.35l.89-.89 3.133 2.374a.817.817 0 001.15-.166.819.819 0 000-.985l-2.368-3.143.867-.871a.387.387 0 00-.269-.664L12.388 12a.397.397 0 00-.388.389v3.692c0 .342.418.514.662.27"/></g></svg>');\n          } else {\n            fullscreenButton.src = 'data:image/svg+xml,' + encodeURIComponent('<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g fill="' + fillColor + '" fill-rule="evenodd"><path d="M16.338 7.35l-.89-.891-3.133 2.374a.815.815 0 01-1.15-.165.819.819 0 010-.986l2.368-3.142-.867-.871a.387.387 0 01.269-.664L16.612 3a.397.397 0 01.388.389V7.08a.387.387 0 01-.662.27M3.662 12.65l.89.89 3.133-2.374a.817.817 0 011.15.166.819.819 0 010 .985l-2.37 3.143.87.871c.248.25.071.664-.27.664L3.388 17A.397.397 0 013 16.611V12.92c0-.342.418-.514.662-.27M3.662 7.35l.89-.891 3.133 2.374a.815.815 0 001.15-.165.819.819 0 000-.986L6.465 4.54l.87-.871a.387.387 0 00-.27-.664L3.388 3A.397.397 0 003 3.389V7.08c0 .341.418.514.662.27M16.338 12.65l-.89.89-3.133-2.374a.817.817 0 00-1.15.166.819.819 0 000 .985l2.368 3.143-.867.871a.387.387 0 00.269.664l3.677.005a.397.397 0 00.388-.389V12.92a.387.387 0 00-.662-.27"/></g></svg>');\n          }\n        };\n        updateFullScreen();\n        document.addEventListener('fullscreenchange', updateFullScreen);\n        document.addEventListener('webkitfullscreenchange', updateFullScreen);\n        if (otherControlsExist) {\n          fullscreenButton.className = 'control-button fullscreen-button';\n          scaffolding.addControlButton({\n            element: fullscreenButton,\n            where: 'top-right'\n          });\n        } else {\n          fullscreenButton.className = 'standalone-fullscreen-button';\n          document.body.appendChild(fullscreenButton);\n        }\n      }`:""}\n\n      vm.setTurboMode(${this.options.turbo});\n      if (vm.setInterpolation) vm.setInterpolation(${this.options.interpolation});\n      if (vm.setFramerate) vm.setFramerate(${this.options.framerate});\n      if (vm.renderer.setUseHighQualityRender) vm.renderer.setUseHighQualityRender(${this.options.highQualityPen});\n      if (vm.setRuntimeOptions) vm.setRuntimeOptions({\n        fencing: ${this.options.fencing},\n        miscLimits: ${this.options.miscLimits},\n        maxClones: ${this.options.maxClones},\n      });\n      if (vm.setCompilerOptions) vm.setCompilerOptions({\n        enabled: ${this.options.compiler.enabled},\n        warpTimer: ${this.options.compiler.warpTimer}\n      });\n\n      if (typeof ScaffoldingAddons !== 'undefined') {\n        ScaffoldingAddons.run(scaffolding, ${JSON.stringify(this.getAddonOptions())});\n      }\n\n      for (const extension of ${JSON.stringify(this.options.extensions.map(e=>e.url))}) {\n        vm.extensionManager.loadExtensionURL(extension);\n      }\n\n      ${this.options.target.startsWith("nwjs-")?"\n      if (typeof nw !== 'undefined') {\n        const win = nw.Window.get();\n        win.on('new-win-policy', (frame, url, policy) => {\n          policy.ignore();\n          nw.Shell.openExternal(url);\n        });\n        win.on('navigation', (frame, url, policy) => {\n          policy.ignore();\n          nw.Shell.openExternal(url);\n        });\n        document.addEventListener('keydown', (e) => {\n          if (e.key === 'Escape' && document.fullscreenElement) {\n            document.exitFullscreen();\n          }\n        });\n      }":""}\n    } catch (e) {\n      handleError(e);\n    }\n  `,t.split("\n").filter((e,t,n)=>0===t||t===n.length-1||0!==e.trim().length||0!==n[t-1].trim().length).join("\n")}<\/script>\n  <script>${this.options.custom.js}<\/script>\n  ${await this.generateGetProjectData()}\n  <script>\n    const run = async () => {\n      const projectData = await getProjectData();\n      await scaffolding.loadProject(projectData);\n      setProgress(1);\n      loadingScreen.hidden = true;\n      if (${this.options.autoplay}) {\n        scaffolding.start();\n      } else {\n        launchScreen.hidden = false;\n        launchScreen.addEventListener('click', () => {\n          launchScreen.hidden = true;\n          scaffolding.start();\n        });\n        launchScreen.focus();\n      }\n    };\n    run().catch(handleError);\n  <\/script>\n</body>\n</html>\n`;var t;if(this.ensureNotAborted(),"html"!==this.options.target){let t;if("sb3"===this.project.type&&"zip-one-asset"!==this.options.target){t=await(await A()).loadAsync(this.project.arrayBuffer);for(const e of Object.keys(t.files))t.files["assets/"+e]=t.files[e],delete t.files[e]}else t=new(await A()),t.file("project.zip",this.project.arrayBuffer);return t.file("index.html",e),t.file("script.js",this.script),this.options.target.startsWith("nwjs-")?t=await this.addNwJS(t):this.options.target.startsWith("electron-")?t=await this.addElectron(t):"webview-mac"===this.options.target&&(t=await this.addWebViewMac(t)),this.ensureNotAborted(),{data:await t.generateAsync({type:"arraybuffer",compression:"DEFLATE",platform:"UNIX"},e=>{this.dispatchEvent(new r("zip-progress",{detail:{progress:e.percent/100}}))}),type:"application/zip",filename:this.generateFilename("zip")}}return{data:e,type:"text/html",filename:this.generateFilename("html")}}}C.adapter=null,C.getDefaultPackageNameFromFileName=e=>(e=(e=(e=(e=e.split(".")[0]).replace(/[^\-a-z ]/gi,"")).trim()).replace(/ /g,"-")).toLowerCase()||"packaged-project",C.getWindowTitleFromFileName=e=>(e=(e=e.trim()).split(".")[0])||"Packaged Project",C.DEFAULT_OPTIONS=()=>({turbo:!1,interpolation:!1,framerate:30,highQualityPen:!1,maxClones:300,fencing:!0,miscLimits:!0,stageWidth:480,stageHeight:360,resizeMode:"preserve-ratio",autoplay:!1,username:"player####",projectId:"",custom:{css:"",js:""},appearance:{background:"#000000",foreground:"#ffffff",accent:S.ACCENT_COLOR},loadingScreen:{progressBar:!0,text:"",imageMode:"normal",image:null},controls:{greenFlag:{enabled:!1},stopAll:{enabled:!1},fullscreen:{enabled:!1},pause:{enabled:!1}},monitors:{editableLists:!1},compiler:{enabled:!0,warpTimer:!1},target:"html",app:{icon:null,packageName:C.getDefaultPackageNameFromFileName(""),windowTitle:C.getWindowTitleFromFileName(""),windowMode:"window"},chunks:{gamepad:!1,pointerlock:!1},cloudVariables:{mode:"ws",cloudHost:"wss://clouddata.turbowarp.org",custom:{},specialCloudBehaviors:!1,unsafeCloudBehaviors:!1},cursor:{type:"auto",custom:null},extensions:[]});var L=C,j=n(3),k=n.n(j),P=n(1),B=n.n(P);const $="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#%()*+,-./:;=?@[]^_`{|}~",F=e=>{e>1309&&e++;let t="";for(;e>=0;)t=$[e%$.length]+t,e=Math.floor(e/$.length)-1;return t};class M{constructor(){this.generatedIds=new Map,this.references=new Map}addReference(e){const t=this.references.get(e)||0;this.references.set(e,t+1)}generateNewIds(){const e=Array.from(this.references.entries());e.sort((e,t)=>t[1]-e[1]);for(let t=0;t<e.length;t++)this.generatedIds.set(e[t][0],F(t))}getNewId(e){if(this.generatedIds.has(e))return this.generatedIds.get(e);throw new Error("getNewId called with unknown ID "+e)}}var D=e=>{const t=new M,n=new M;if(e.monitors)for(const n of e.monitors){const e=n.opcode;if("data_variable"===e||"data_listcontents"===e){const e=n.id;t.addReference(e)}}const s=e=>{const n=e[0];if(12===n||13===n){const n=e[2];t.addReference(n)}else if(11===n){const n=e[2];t.addReference(n)}};for(const o of e.targets){for(const e of Object.keys(o.variables))t.addReference(e);for(const e of Object.keys(o.lists))t.addReference(e);for(const e of Object.keys(o.broadcasts))t.addReference(e);for(const[e,r]of Object.entries(o.blocks))if(n.addReference(e),Array.isArray(r))s(r);else{r.parent&&n.addReference(r.parent),r.next&&n.addReference(r.next),r.fields.VARIABLE&&t.addReference(r.fields.VARIABLE[1]),r.fields.LIST&&t.addReference(r.fields.LIST[1]),r.fields.BROADCAST_OPTION&&t.addReference(r.fields.BROADCAST_OPTION[1]);for(const e of Object.values(r.inputs))for(let t=1;t<e.length;t++){const o=e[t];"string"==typeof o?n.addReference(o):Array.isArray(o)&&s(o)}}}if(t.generateNewIds(),n.generateNewIds(),e.monitors)for(const n of e.monitors){const e=n.opcode;if("data_variable"===e||"data_listcontents"===e){const e=n.id;n.id=t.getNewId(e)}n.value=Array.isArray(n.value)?[]:0}const o=e=>{const n=e[0];if(12===n||13===n){const n=e[2];e[2]=t.getNewId(n)}else if(11===n){const n=e[2];e[2]=t.getNewId(n)}};for(const s of e.targets){const e={},r={},i={},a={},c={};for(const[n,o]of Object.entries(s.variables))e[t.getNewId(n)]=o;for(const[e,n]of Object.entries(s.lists))r[t.getNewId(e)]=n;for(const[e,n]of Object.entries(s.broadcasts))i[t.getNewId(e)]=n;for(const[e,r]of Object.entries(s.blocks))if(a[n.getNewId(e)]=r,Array.isArray(r))o(r);else{r.parent&&(r.parent=n.getNewId(r.parent)),r.next&&(r.next=n.getNewId(r.next)),r.fields.VARIABLE&&(r.fields.VARIABLE[1]=t.getNewId(r.fields.VARIABLE[1])),r.fields.LIST&&(r.fields.LIST[1]=t.getNewId(r.fields.LIST[1])),r.fields.BROADCAST_OPTION&&(r.fields.BROADCAST_OPTION[1]=t.getNewId(r.fields.BROADCAST_OPTION[1]));for(const e of Object.values(r.inputs))for(let t=1;t<e.length;t++){const s=e[t];"string"==typeof s?e[t]=n.getNewId(s):Array.isArray(s)&&o(s)}r.shadow||delete r.shadow,r.topLevel||delete r.topLevel,delete r.x,delete r.y,delete r.comment}for(const[e,t]of Object.entries(s.comments)){const n=t.text;(n.includes(" // _twconfig_")||n.includes(" // _gamepad_"))&&(c[e]=t)}s.variables=e,s.lists=r,s.broadcasts=i,s.blocks=a,s.comments=c}return e.meta&&(delete e.meta.agent,delete e.meta.vm),e};const U="https://assets.scratch.mit.edu/internalapi/asset/$path/get/",W=e=>{const t=[];for(const n of e)if(Array.isArray(n))for(const e of n)t.push(e);else t.push(n);return t},_=e=>"targets"in e?"sb3":"objName"in e?"sb2":null,z=e=>{const t=(e.variables||[]).map(({name:e,isPersistent:t})=>({name:e,isCloud:t})),n=JSON.stringify(e);return{stageVariables:[],stageComments:[],usesMusic:!0,stageVariables:t,usesMusic:n.includes("drum:duration:elapsed:from:")||n.includes("playDrum")||n.includes("noteOn:duration:elapsed:from:")}},H=e=>{const t=e.targets[0];if(!t||!t.isStage)throw new Error("Project does not have stage");return{stageVariables:[],stageComments:[],usesMusic:!0,stageVariables:Object.values(t.variables).map(([e,t,n])=>({name:e,isCloud:!!n})),stageComments:Object.values(t.comments).map(e=>e.text),usesMusic:e.extensions.includes("music")}},V=e=>((e=>{const t=e.targets.find(e=>e.isStage);if(t)for(const e of Object.values(t.variables)){e[0].startsWith("☁")&&(e[2]=!0)}})(e),D(e),e),G=(e,t)=>{const n=["svg","png","jpg","jpeg","bmp"],s=["wav","mp3"],o=new k.a;let i=0,a=0;const c=e=>e.split(".")[1]||"",l=[e,...e.children.filter(e=>!e.listName&&!e.target)];return(e=>{const l=new Map,d=e=>(l.has(e)||l.set(e,(e=>{const t=c(e);return n.includes(t)?a++:s.includes(t)?i++:(console.warn("unknown extension: "+t),a++)})(e)),l.get(e));for(const t of e)t.md5&&(t.soundID=d(t.md5)),t.baseLayerMD5&&(t.baseLayerID=d(t.baseLayerMD5)),t.textLayerMD5&&(t.textLayerID=d(t.textLayerMD5));return Promise.all(Array.from(l.entries()).map(([e,n])=>((e,n)=>(t.dispatchEvent(new r("asset-fetch",{detail:e})),B()(U.replace("$path",e)).then(e=>e.arrayBuffer()).then(s=>{const i=`${n}.${c(e)}`;o.file(i,s),t.dispatchEvent(new r("asset-fetched",{detail:e}))})))(e,n)))})([...W(l.map(e=>e.costumes||[])),...W(l.map(e=>e.sounds||[]))]).then(()=>(o.file("project.json",JSON.stringify(e)),{zip:o,analysis:z(e)}))},J=(e,t)=>{const n=new k.a;n.file("project.json",JSON.stringify(V(e)));const s=e.targets,o=(e=>{const t=[],n=new Set;for(const s of e){const e=s.md5ext;n.has(e)||(n.add(e),t.push(s))}return t})([...W(s.map(e=>e.costumes||[])),...W(s.map(e=>e.sounds||[]))]);return Promise.all(o.map(e=>(e=>{const s=e.md5ext||e.assetId+"."+e.dataFormat;return t.dispatchEvent(new r("asset-fetch",{detail:s})),B()(U.replace("$path",s)).then(e=>e.arrayBuffer()).then(e=>{n.file(s,e),t.dispatchEvent(new r("asset-fetched",{detail:s}))})})(e))).then(()=>({zip:n,analysis:H(e)}))},q=async(e,t=(()=>{}))=>{let n,s,r;const i=new Uint8Array(e);if(i[0]==="{".charCodeAt(0)){const i=new o;let a,c=!1,l=0,d=0;const p=()=>{a||setTimeout(()=>{c||t("assets",l,d)})};i.addEventListener("asset-fetch",()=>{d++,p()}),i.addEventListener("asset-fetched",()=>{l++,p()});const u=(new TextDecoder).decode(e),f=JSON.parse(u);n=_(f);const h=await((e,t)=>{const n=_(e);if("sb3"===n)return J(e,t);if("sb2"===n)return G(e,t);throw new Error("Unknown project type")})(f,i);t("assets",d,d),c=!0,s=await h.zip.generateAsync({type:"arraybuffer",compression:"DEFLATE"},e=>{t("compress",e.percent/100)}),r=h.analysis}else if((e=>{for(let t=0;t<"ScratchV".length;t++)if(e[t]!=="ScratchV".charCodeAt(t))return!1;return!0})(i))s=e,r={stageVariables:[],stageComments:[],usesMusic:!0};else{let o;try{o=await k.a.loadAsync(e)}catch(e){throw new Error("Cannot parse project: not a zip or sb")}const i=o.file(/^([^/]*\/)?project\.json$/)[0];if(!i)throw new Error("project.json is missing");const a=i.name.substr(0,i.name.indexOf("project.json"));""!==a&&(o=o.folder(a));const c=await i.async("text"),l=JSON.parse(c);n=_(l),"sb3"===n?(o.file("project.json",JSON.stringify(V(l))),s=await o.generateAsync({type:"arraybuffer",compression:"DEFLATE"},e=>{t("compress",e.percent/100)}),r=H(l)):(s=e,r=z(l))}return"sb3"===n?{type:"sb3",arrayBuffer:s,analysis:r}:{type:"blob",arrayBuffer:s,analysis:r}};var Y=n(4),X=n.n(Y),Q=n(2),K=n.n(Q),Z=n(5),ee=n(7),te=n.p+"290e09e569a1cab8e61ba93b0d23863f.png";const ne=Object(Z.promisify)(X.a.readFile),se=Object(Z.promisify)(X.a.writeFile),oe=Object(Z.promisify)(X.a.mkdir),re=(e,t)=>{e=K.a.join(e,"/");const n=K.a.join(e,t);return n.startsWith(e)?n:null},ie=K.a.join(__dirname,"..",".packager-cache");var ae=class{async getCachedAsset(e){if(e.src.startsWith("scaffolding/")){const t=re(__dirname,e.src);if(t)return ne(t,"utf-8")}if(e.src.startsWith("https:")){const n=await(async e=>{if(!e.sha256)return null;const t=re(ie,e.sha256);return t?(await oe(ie,{recursive:!0}),t):null})(e);if(n)try{return(t=await ne(n)).buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}catch(e){}console.log(`[${ee.a}]: downloading large asset ${e.src}; this may take a while`);const s=await B()(e.src);if(!s.ok)throw new Error("Unexpected status code: "+s.status);const o=await s.arrayBuffer();return n&&await se(n,(e=>Buffer.from(e))(o)),o}var t}async cacheAsset(e,t){}async getAppIcon(e){const t=await ne(K.a.join(__dirname,te));return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}readAsURL(e){throw new Error("image features not implemented in Node.js module")}};L.adapter=new ae},function(e,t){e.exports=s},function(e,t){e.exports=require("buffer")}])}));
\ No newline at end of file
+!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("cross-fetch"),require("jszip"),require("sha.js"),require("@fiahfy/icns")):"function"==typeof define&&define.amd?define(["cross-fetch","jszip","sha.js","@fiahfy/icns"],t):"object"==typeof exports?exports.packager=t(require("cross-fetch"),require("jszip"),require("sha.js"),require("@fiahfy/icns")):e.packager=t(e["cross-fetch"],e.jszip,e["sha.js"],e["@fiahfy/icns"])}(global,(function(e,t,n,s){return function(e){var t={},n={1:0};function s(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,s),o.l=!0,o.exports}return s.e=function(t){if(0!==n[t]){var s=require("./"+({0:"icns"}[t]||t)+".js"),o=s.modules,r=s.ids;for(var i in o)e[i]=o[i];for(var a=0;a<r.length;a++)n[r[a]]=0}return Promise.all([])},s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(n,o,function(t){return e[t]}.bind(null,o));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s.oe=function(e){process.nextTick((function(){throw e}))},s(s.s=8)}([function(e,t){e.exports={APP_NAME:"TurboWarp Packager",LONG_NAME:"TurboWarp Packager for Scratch",WEBSITE:"https://packager.turbowarp.org/",COPYRIGHT_NOTICE:"Copyright (C) 2021 Thomas Weber\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License version 3\nas published by the Free Software Foundation.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with this program. If not, see <https://www.gnu.org/licenses/>.",ACCENT_COLOR:"#ff4c4c",SOURCE_CODE:"https://github.com/TurboWarp/packager",FEEDBACK_PRIMARY:{name:"Scratch",link:"https://scratch.mit.edu/users/GarboMuffin/#comments"},FEEDBACK_SECONDARY:{name:"GitHub",link:"https://github.com/TurboWarp/packager/issues"}}},function(t,n){t.exports=e},function(e,t){e.exports=require("path")},function(e,n){e.exports=t},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("util")},function(e,t){e.exports=n},function(e){e.exports=JSON.parse('{"a":"@turbowarp/packager"}')},function(e,t,n){"use strict";n.r(t),n.d(t,"Packager",(function(){return L})),n.d(t,"loadProject",(function(){return q}));var s={};n.r(s),n.d(s,"sha256",(function(){return c}));class o{constructor(){this._events={}}addEventListener(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t)}removeEventListener(e,t){const n=this._events[e];n&&(this._events[e]=n.filter(e=>e!==t))}dispatchEvent(e){const t=this._events[e.type];if(t)for(const n of t)n(e)}}class r{constructor(e,{detail:t}){this.type=e,this.detail=t}}var i=n(6),a=n.n(i);const c=e=>a()("sha256").update(new Uint8Array(e)).digest("hex");var l=()=>({worker:s,terminate:()=>{}});var d=e=>e.replace(/["'<>&]/g,e=>{switch(e){case'"':return"&quot;";case"'":return"&apos;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;"}});const p="https://packagerdata.turbowarp.org/";var u={"nwjs-win64":{src:p+"nwjs-v0.54.0-win-x64.zip",sha256:"0f082671b67b711f783d98cc989cf5aebacfc9bce3bef78875b57d08fc2a6e86",type:"arraybuffer"},"nwjs-win32":{src:p+"nwjs-v0.54.0-win-ia32.zip",sha256:"7a1ed3a6a51b8cdf9280761b90cb4723cf9ee8050e3ed0b58451e8e4e694b203",type:"arraybuffer"},"nwjs-mac":{src:p+"nwjs-v0.54.0-osx-x64.zip",sha256:"498c97a264f8feac504c4c2396c1fddc8290c15573aee2fc692e59ff9803cc40",type:"arraybuffer"},"nwjs-linux-x64":{src:p+"nwjs-v0.54.0-linux-x64.zip",sha256:"53651a3a12d29ad096cff5b44d9f1e3aa09e9fad970bdcfe8bda07ea23d960d8",type:"arraybuffer"},"electron-win32":{src:p+"electron-v15.0.0-win32-ia32.zip",sha256:"5b69112b91010d78abf6012f387ea3fe5c0e36657c5f386a4c2bb42138aa1a8e",type:"arraybuffer"},"electron-win64":{src:p+"electron-v15.0.0-win32-x64.zip",sha256:"3d95422d9f2fccb07b745b31007548231d80ff63e3640f49a5f8591498a3afa2",type:"arraybuffer"},"electron-linux64":{src:p+"electron-v15.1.1-linux-x64.zip",sha256:"70de2da51c6a8591b88f08366c82166a51b1719243f67ef1a14eddbb806a115f",type:"arraybuffer"},"webview-mac":{src:p+"WebView-macos-3.zip",sha256:"5d4086894f10549c61c20e5f770c808afc25c2e4793da75b5b1cede294449fac",type:"arraybuffer"},scaffolding:{src:"scaffolding/scaffolding.js",estimatedSize:4775503,useBuildId:!0,type:"text"},"scaffolding-min":{src:"scaffolding/scaffolding-min.js",estimatedSize:2540321,useBuildId:!0,type:"text"},addons:{src:"scaffolding/addons.js",estimatedSize:14339,useBuildId:!0,type:"text"}};const f=e=>Math.max(0,Math.min(1,e));var h=({url:e,type:t,progressCallback:n,timeout:s,estimatedSize:o,abortTarget:r})=>new Promise((i,a)=>{const c=new XMLHttpRequest;c.onload=()=>{l(),200===c.status?i(c.response):a(new Error("Request failed with status code: "+c.status))},c.onerror=()=>{l(),a(new Error("Request failed, are you offline?"))},n&&(c.onprogress=e=>{e.lengthComputable?n(f(e.loaded/e.total)):o&&n(f(e.loaded/o))}),c.responseType=t,c.open("GET",e),c.send();const l=()=>{d&&d(),p&&clearTimeout(p)};let d,p;if(r){const e=()=>{c.abort(),l(),a(new Error("Request aborted"))};r.addEventListener("abort",e),d=()=>{r.removeEventListener("abort",e)}}s&&(p=setTimeout(()=>{c.abort(),l(),a(new Error("Request timed out"))},s))});const g=e=>new Promise((t,n)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=()=>n(new Error("Cannot read as array buffer: "+s.error)),s.readAsArrayBuffer(e)}),m=e=>new Promise((t,n)=>{e.toBlob(e=>{e?t(e):n(new Error("Could not read <canvas> as blob"))})});var w=async e=>{const{Icns:t,Buffer:s}=await n.e(0).then(n.bind(null,11)),o=new Blob([e],{type:"image/png"}),r=URL.createObjectURL(o),i=await(a=r,new Promise((e,t)=>{const n=new Image;n.onload=()=>e(n),n.onerror=()=>t(new Error("Could not load image: "+a)),n.src=a}));var a;const c=[{type:"ic04",size:16},{type:"ic07",size:128},{type:"ic08",size:256},{type:"ic09",size:512},{type:"ic10",size:1024},{type:"ic11",size:32},{type:"ic12",size:64},{type:"ic13",size:256},{type:"ic14",size:512}].filter(e=>16===e.size||i.width>=e.size&&i.height>=e.size),l=document.createElement("canvas"),d=l.getContext("2d");if(!d)throw new Error("cannot get canvas rendering context");const p=new t.Icns;for(const e of c){const n=e.size;l.width=n,l.height=n,d.drawImage(i,0,0,n,n);const o=await m(l),r=await g(o),a=await t.IcnsImage.fromPNG(s.from(r),e.type);p.append(a)}return p.data};const b="811095aaf2285f384fcdcbdd901b356eb3202005e490c913b0b79a56185ce270",y=e=>{const t=e=>(40===e&&(e=60),41===e&&(e=62),e-42),n=e.indexOf(","),s=+e.substring(0,n).split("").map(e=>String.fromCharCode(e.charCodeAt(0)-49)).join(""),o=new ArrayBuffer((r=s)%4==0?r:r+(4-r%4));var r;const i=new Uint32Array(o);for(let s=n+1,o=0;s<e.length;s+=5,o++)i[o]=85*t(e.charCodeAt(s+4))*85*85*85+85*t(e.charCodeAt(s+3))*85*85+85*t(e.charCodeAt(s+2))*85+85*t(e.charCodeAt(s+1))+t(e.charCodeAt(s));return new Uint8Array(o,0,s)},v=e=>{if("dict"===e.tagName){const t={};for(const n of e.children)"key"===n.tagName&&(t[n.textContent]=v(n.nextElementSibling));return t}return"array"===e.tagName?Array.from(e.children).map(v):"string"===e.tagName?e.textContent:(console.warn("unknown plist xml",e),null)},E=(e,t)=>{if(Array.isArray(t)){const n=e.createElement("array");for(const s of t)n.appendChild(E(e,s));return n}if("object"==typeof t){const n=e.createElement("dict");for(const[s,o]of Object.entries(t)){const t=e.createElement("key");t.textContent=s;const r=E(e,o);n.appendChild(t),n.appendChild(r)}return n}if("string"==typeof t){const n=e.createElement("string");return n.textContent=t,n}return console.warn("unknown plist value",t),E(e,""+t)};var S=n(0);const A=async()=>(await Promise.resolve().then(n.t.bind(null,3,7))).default,I=(e,t,n)=>{e.files[t]=n},O={title:S.APP_NAME,homepage:S.WEBSITE,license:S.COPYRIGHT_NOTICE},T={title:"Scratch",homepage:"https://scratch.mit.edu/",license:'Copyright (c) 2016, Massachusetts Institute of Technology\nAll rights reserved.\n\nRedistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n\n1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n\n2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n\n3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.'},x={title:"Electron",homepage:"https://www.electronjs.org/",license:'Copyright (c) Electron contributors\nCopyright (c) 2013-2020 GitHub Inc.\n\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n"Software"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\nOF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\nWITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.'},N=`/*!\nParts of this script are from the ${S.APP_NAME} <${S.WEBSITE}>, licensed as follows:\n${O.license}\n\nParts of this script are from Scratch <https://scratch.mit.edu/>, licensed as follows:\n${T.license}\n*/\n`,R=e=>`<style>body { font-family: sans-serif; }</style>${`<h2>The following entries were added by the ${S.APP_NAME}</h2>`}${e.map(({title:e,license:t,homepage:n},s)=>`\n<div class="product">\n<span class="title">${d(e)}</span>\n<span class="homepage"><a href="${d(n)}">homepage</a></span>\n<input type="checkbox" hidden id="p4-${s}">\n<label class="show" for="p4-${s}" tabindex="0"></label>\n<div class="licence">\n<pre>${d(t)}</pre>\n</div>\n</div>\n`).join("\n")}`;class C extends o{constructor(){super(),this.project=null,this.options=C.DEFAULT_OPTIONS(),this.aborted=!1,this.used=!1}abort(){this.aborted||(this.aborted=!0,this.dispatchEvent(new Event("abort")))}ensureNotAborted(){if(this.aborted)throw new Error("Aborted")}async fetchLargeAsset(e){this.ensureNotAborted();const t=u[e];if(!t)throw new Error("Invalid asset: "+e);if("undefined"!=typeof __ASSETS__&&__ASSETS__[t.src])return __ASSETS__[t.src];const n=t=>this.dispatchEvent(new r("large-asset-fetch",{detail:{asset:e,progress:t}}));let s;n(0);let o=!1;try{const e=await C.adapter.getCachedAsset(t);e&&(s=e,o=!0,n(.5))}catch(e){console.warn(e)}if(!s){let e=t.src;t.useBuildId&&(e+="?"+b),s=await h({url:e,type:t.type,estimatedSize:t.estimatedSize,progressCallback:e=>{n(e)},abortTarget:this})}if(t.useBuildId&&(i=b,(a=s).endsWith("=^..^=")&&!a.endsWith(i+" =^..^=")))throw new Error("Build ID mismatch; This should be fixed after refreshing the page.");var i,a;if(t.sha256){const n=await(async e=>{const{worker:t,terminate:n}=l(),s=await t.sha256(e);return n(),s})(s);if(n!==t.sha256)throw new Error(`Hash mismatch for ${e}, found ${n} but expected ${t.sha256}`)}if(!o)try{await C.adapter.cacheAsset(t,s)}catch(e){console.warn(e)}return n(1),s}getAddonOptions(){return{...this.options.chunks,specialCloudBehaviors:this.options.cloudVariables.specialCloudBehaviors,unsafeCloudBehaviors:this.options.cloudVariables.unsafeCloudBehaviors,pause:this.options.controls.pause.enabled}}async loadResources(){const e=[N];this.project.analysis.usesMusic?e.push(await this.fetchLargeAsset("scaffolding")):e.push(await this.fetchLargeAsset("scaffolding-min")),Object.values(this.getAddonOptions()).some(e=>e)&&e.push(await this.fetchLargeAsset("addons")),this.script=e.join("\n").replace(/<\/script>/g,"</scri'+'pt>")}computeWindowSize(){let e=this.options.stageWidth,t=this.options.stageHeight;return(this.options.controls.greenFlag.enabled||this.options.controls.stopAll.enabled||this.options.controls.pause.enabled)&&(t+=48),{width:e,height:t}}async addNwJS(e){const t=await this.fetchLargeAsset(this.options.target),n=await(await A()).loadAsync(t),s=this.options.target.startsWith("nwjs-win"),o="nwjs-mac"===this.options.target,r=this.options.target.startsWith("nwjs-linux"),i=Object.keys(n.files)[0].split("/")[0],a=new(await A()),c=this.options.app.packageName;for(const e of Object.keys(n.files)){const t=n.files[e];let l=e.replace(i,c);s?l=l.replace("nw.exe",c+".exe"):o?l=l.replace("nwjs.app",c+".app"):r&&(l=l.replace(/nw$/,c)),I(a,l,t)}const l=await C.adapter.getAppIcon(this.options.app.icon),d={name:c,main:"main.js",window:{width:this.computeWindowSize().width,height:this.computeWindowSize().height,icon:"icon.png"}};let p;if(s)p=c+"/";else if(o){const e=await w(l);a.file(`${c}/${c}.app/Contents/Resources/app.icns`,e),p=`${c}/${c}.app/Contents/Resources/app.nw/`}else if(r){const e='#!/bin/bash\ncd "$(dirname "$0")"\n./'+c;a.file(c+"/start.sh",e,{unixPermissions:33261}),p=c+"/"}for(const t of Object.keys(e.files))I(a,p+t,e.files[t]);a.file(p+"icon.png",l),a.file(p+"package.json",JSON.stringify(d,null,4)),a.file(p+"main.js","\n    const start = () => nw.Window.open('index.html', {\n      position: 'center',\n      new_instance: true\n    });\n    nw.App.on('open', start);\n    start();");const u=c+"/credits.html",f=await a.file(u).async("string");return a.file(u,f+R([O,T])),a}async addElectron(e){const t=await this.fetchLargeAsset(this.options.target),n=await(await A()).loadAsync(t),s=this.options.target.includes("win"),o=this.options.target.includes("linux"),r=new(await A()),i=this.options.app.packageName;for(const e of Object.keys(n.files)){const t=n.files[e];let a=`${i}/${e}`;s?a=a.replace("electron.exe",i+".exe"):o&&(a=a.replace(/electron$/,i)),I(r,a,t)}const a=await r.file(i+"/LICENSES.chromium.html").async("string");r.file(i+"/licenses.html",a+R([O,T,x])),r.remove(i+"/LICENSE.txt"),r.remove(i+"/LICENSES.chromium.html"),r.remove(i+"/LICENSE"),r.remove(i+"/version"),r.remove(i+"/resources/default_app.asar");const c=i+"/",l=c+"resources/app/",d=await C.adapter.getAppIcon(this.options.app.icon);r.file(l+"icon.png",d);const p={name:i,main:"electron-main.js"};r.file(l+"package.json",JSON.stringify(p));const u=`'use strict';\nconst {app, BrowserWindow, Menu, shell, screen} = require('electron');\nconst path = require('path');\n\nconst isWindows = process.platform === 'win32';\nconst isMac = process.platform === 'darwin';\nconst isLinux = process.platform === 'linux';\n\nif (isMac) {\n  // TODO\n  Menu.setApplicationMenu(Menu.buildFromTemplate([\n    { role: 'appMenu' },\n    { role: 'fileMenu' },\n    { role: 'editMenu' },\n    { role: 'viewMenu' },\n    { role: 'windowMenu' },\n    { role: 'help' }\n  ]));\n} else {\n  Menu.setApplicationMenu(null);\n}\n\napp.enableSandbox();\n\nconst createWindow = (windowOptions) => {\n  const options = {\n    title: ${JSON.stringify(this.options.app.windowTitle)},\n    icon: path.resolve(__dirname, ${JSON.stringify("icon.png")}),\n    useContentSize: true,\n    webPreferences: {\n      contextIsolation: true,\n      nodeIntegration: false,\n    },\n    show: true,\n    width: 480,\n    height: 360,\n    ...windowOptions,\n  };\n\n  const activeScreen = screen.getDisplayNearestPoint(screen.getCursorScreenPoint());\n  const bounds = activeScreen.workArea;\n  options.x = bounds.x + ((bounds.width - options.width) / 2);\n  options.y = bounds.y + ((bounds.height - options.height) / 2);\n\n  const window = new BrowserWindow(options);\n  return window;\n};\n\nconst createProjectWindow = () => {\n  const windowMode = ${JSON.stringify(this.options.app.windowMode)};\n  const window = createWindow({\n    show: false,\n    backgroundColor: ${JSON.stringify(this.options.appearance.background)},\n    width: ${this.computeWindowSize().width},\n    height: ${this.computeWindowSize().height},\n    minWidth: 50,\n    minHeight: 50,\n    fullscreen: windowMode === 'fullscreen',\n  });\n  if (windowMode === 'maximize') {\n    window.maximize();\n  }\n  window.loadFile(path.resolve(__dirname, './index.html'));\n  window.show();\n};\n\nconst createDataWindow = (dataURI) => {\n  const window = createWindow({});\n  window.loadURL(dataURI);\n};\n\nconst isSafeOpenExternal = (url) => {\n  try {\n    const parsedUrl = new URL(url);\n    return parsedUrl.protocol === 'https:' || parsedUrl.protocol === 'http:';\n  } catch (e) {\n    // ignore\n  }\n  return false;\n};\n\nconst isDataURL = (url) => {\n  try {\n    const parsedUrl = new URL(url);\n    return parsedUrl.protocol === 'data:';\n  } catch (e) {\n    // ignore\n  }\n  return false;\n};\n\nconst openLink = (url) => {\n  if (isSafeOpenExternal(url)) {\n    shell.openExternal(url);\n  } else if (isDataURL(url)) {\n    createDataWindow(url);\n  }\n};\n\napp.on('web-contents-created', (event, contents) => {\n  contents.setWindowOpenHandler((details) => {\n    setImmediate(() => {\n      openLink(details.url);\n    });\n    return {action: 'deny'};\n  });\n  contents.on('will-navigate', (e, url) => {\n    e.preventDefault();\n    openLink(url);\n  });\n  contents.on('before-input-event', (e, input) => {\n    const window = BrowserWindow.fromWebContents(contents);\n    if (!window || input.type !== "keyDown") return;\n    if (input.key === 'F11' || (input.key === 'Enter' && input.alt)) {\n      window.setFullScreen(!window.isFullScreen());\n    } else if (input.key === 'Escape' && window.isFullScreen()) {\n      window.setFullScreen(false);\n    }\n  });\n});\n\napp.on('window-all-closed', () => {\n  app.quit();\n});\n\napp.whenReady().then(() => {\n  createProjectWindow();\n  app.on('activate', () => {\n    if (BrowserWindow.getAllWindows().length === 0) {\n      createProjectWindow();\n    }\n  });\n});\n`;r.file(l+"electron-main.js",u);for(const[t,n]of Object.entries(e.files))I(r,`${l}${t}`,n);if(s){const e=`Open "${i}.exe" to start the app. Open "licenses.html" for information regarding software licenses used by the app.`;r.file(c+"README.txt",e)}else if(o){const e='#!/bin/bash\ncd "$(dirname "$0")"\n./'+i;r.file(c+"start.sh",e,{unixPermissions:33261})}return r}async addWebViewMac(e){const t=await this.fetchLargeAsset(this.options.target),n=await(await A()).loadAsync(t),s=this.options.app.packageName+".app",o=s+"/Contents/",r=s+"/Contents/Resources/",i=new(await A());for(const[e,t]of Object.entries(n.files)){const n=e.replace("WebView.app",s).replace(/WebView$/,this.options.app.packageName);I(i,n,t)}for(const[t,n]of Object.entries(e.files))I(i,`${r}${t}`,n);const a=await C.adapter.getAppIcon(this.options.app.icon),c=await w(a);i.file(r+"AppIcon.icns",c),i.remove(r+"Assets.car");const l=parseInt(this.options.appearance.background.substr(1),16),d={title:this.options.app.windowTitle,background:[l>>16&255,l>>8&255,255&l,1],width:this.computeWindowSize().width,height:this.computeWindowSize().height};i.file(r+"application_config.json",JSON.stringify(d));const p=(e=>{const t=(new DOMParser).parseFromString(e,"text/xml").children[0].children[0];return v(t)})(await i.file(o+"Info.plist").async("string"));return p.CFBundleIdentifier="org.turbowarp.packager.userland."+this.options.app.packageName,p.CFBundleName=this.options.app.windowTitle,p.CFBundleExecutable=this.options.app.packageName,i.file(o+"Info.plist",(e=>{const t=document.implementation.createDocument(null,"plist"),n=t.documentElement;n.setAttribute("version","1.0"),n.appendChild(E(t,e));return'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n'+(new XMLSerializer).serializeToString(t)})(p)),i}makeWebSocketProvider(){const e="wss://clouddata.turbowarp.org"===this.options.cloudVariables.cloudHost?["wss://clouddata.turbowarp.org","wss://clouddata.turbowarp.xyz"]:this.options.cloudVariables.cloudHost;return`new Scaffolding.Cloud.WebSocketProvider(${JSON.stringify(e)}, ${JSON.stringify(this.options.projectId)})`}makeLocalStorageProvider(){return`new Scaffolding.Cloud.LocalStorageProvider(${JSON.stringify("cloudvariables:"+this.options.projectId)})`}makeCustomProvider(){const e=this.options.cloudVariables.custom;let t="{const providers = {};\n";for(const n of new Set(Object.values(e)))"ws"===n?t+=`providers.ws = ${this.makeWebSocketProvider()};\n`:"local"===n&&(t+=`providers.local = ${this.makeLocalStorageProvider()};\n`);t+="for (const provider of Object.values(providers)) scaffolding.addCloudProvider(provider);\n";for(const n of Object.keys(e)){const s=e[n];t+=`scaffolding.addCloudProviderOverride(${JSON.stringify(n)}, providers[${JSON.stringify(s)}] || null);\n`}return t+="}",t}generateFilename(e){return`${this.options.app.windowTitle}.${e}`}async generateGetProjectData(){let e,t,n="",s="",o=!1;if("html"===this.options.target){o="blob"!==this.project.type,e=.75,t=.98;const c=1e5,l=(e=>{const t=e.byteLength;let n;if(t%4!=0){const s=new ArrayBuffer(t+(4-t%4)),o=new Uint8Array(e),r=new Uint8Array(s);for(let e=0;e<o.length;e++)r[e]=o[e];n=new Uint32Array(s)}else n=new Uint32Array(e);const s=t.toString(),o=new ArrayBuffer(s.length+1+5*n.byteLength/4),r=new Uint8Array(o);let i=0;for(let e=0;e<s.length;e++)r[i++]=s.charCodeAt(e)+49;r[i++]=44;const a=e=>60===(e+=42)?40:62===e?41:e;for(let e=0;e<n.length;e++){let t=n[e];r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85),t=Math.floor(t/85),r[i++]=a(t%85)}return(new TextDecoder).decode(o)})(this.project.arrayBuffer);for(let e=0;e<l.length;e+=c){n+=`<script type="p4-project">${l.substr(e,c)}<\/script><script>setProgress(${(r=.1,i=.75,a=e/l.length,r+a*(i-r)).toString().substr(1,4)})<\/script>`}s=`async () => {\n        const base85decode = ${y};\n        const dataElements = Array.from(document.querySelectorAll('script[type="p4-project"]'));\n        const result = base85decode(dataElements.map(i => i.textContent).join(''));\n        dataElements.forEach(i => i.remove());\n        return result;\n      }`}else{let n;"blob"===this.project.type||"zip-one-asset"===this.options.target?(o="blob"!==this.project.type,n="./project.zip",e=.75,t=.98):(n="./assets/project.json",e=.2,t=.98),s=`() => new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        xhr.onload = () => {\n          resolve(xhr.response);\n        };\n        xhr.onerror = () => {\n          if (location.protocol === 'file:') {\n            reject(new Error('Zip environment must be used from a website, not from a file URL.'));\n          } else {\n            reject(new Error('Request to load project data failed.'));\n          }\n        };\n        xhr.onprogress = (e) => {\n          if (e.lengthComputable) {\n            setProgress(interpolate(0.1, ${e}, e.loaded / e.total));\n          }\n        };\n        xhr.responseType = 'arraybuffer';\n        xhr.open('GET', ${JSON.stringify(n)});\n        xhr.send();\n      })`}var r,i,a;return n+=`\n    <script>\n      const getProjectData = (function() {\n        const storage = scaffolding.storage;\n        storage.onprogress = (total, loaded) => {\n          setProgress(interpolate(${e}, ${t}, loaded / total));\n        };\n        ${o?`\n        storage.addHelper({\n          load: (assetType, assetId, dataFormat) => zip.file(assetId + '.' + dataFormat)\n            .async('uint8array')\n            .then((data) => new storage.Asset(assetType, assetId, dataFormat, data))\n        });\n        return () => (${s})().then(async (data) => {\n          zip = await Scaffolding.JSZip.loadAsync(data);\n          return zip.file('project.json').async('arraybuffer');\n        });`:`\n        storage.addWebStore(\n          [storage.AssetType.ImageVector, storage.AssetType.ImageBitmap, storage.AssetType.Sound],\n          (asset) => new URL('./assets/' + asset.assetId + '.' + asset.dataFormat, location).href\n        );\n        return ${s};`}\n      })();\n    <\/script>`,n}async generateFavicon(){if(null===this.options.app.icon)return"";return`<link rel="icon" href="${await C.adapter.readAsURL(this.options.app.icon,"app icon")}">`}async generateCursor(){if("custom"!==this.options.cursor.type)return this.options.cursor.type;if(!this.options.cursor.custom)return"auto";return`url(${await C.adapter.readAsURL(this.options.cursor.custom,"custom cursor")}), auto`}async package(){if(!C.adapter)throw new Error("Missing adapter");if(this.used)throw new Error("Packager was already used");this.used=!0,this.ensureNotAborted(),await this.loadResources(),this.ensureNotAborted();const e=`<!DOCTYPE html>\n\x3c!-- Created with ${S.WEBSITE} --\x3e\n<html>\n<head>\n  <meta charset="utf-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">\n  \x3c!-- We only include this to explicitly loosen the CSP of various packager environments. It does not provide any security. --\x3e\n  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:">\n  <title>${d(this.options.app.windowTitle)}</title>\n  <style>\n    body {\n      color: ${this.options.appearance.foreground};\n      font-family: sans-serif;\n      overflow: hidden;\n      margin: 0;\n      padding: 0;\n    }\n    :root, body.is-fullscreen {\n      background-color: ${this.options.appearance.background};\n    }\n    [hidden] {\n      display: none !important;\n    }\n    h1 {\n      font-weight: normal;\n    }\n    a {\n      color: inherit;\n      text-decoration: underline;\n      cursor: pointer;\n    }\n\n    #app, #loading, #error, #launch {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n    }\n    .screen {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      text-align: center;\n      cursor: default;\n      user-select: none;\n      -webkit-user-select: none;\n      background-color: ${this.options.appearance.background};\n    }\n    #launch {\n      background-color: rgba(0, 0, 0, 0.7);\n      cursor: pointer;\n    }\n    .green-flag {\n      width: 80px;\n      height: 80px;\n      padding: 16px;\n      border-radius: 100%;\n      background: rgba(255, 255, 255, 0.75);\n      border: 3px solid hsla(0, 100%, 100%, 1);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      box-sizing: border-box;\n    }\n    #loading {\n      ${this.options.loadingScreen.image&&"stretch"===this.options.loadingScreen.imageMode?`background-image: url(${await C.adapter.readAsURL(this.options.loadingScreen.image,"stretched loading screen")});\n      background-repeat: no-repeat;\n      background-size: contain;\n      background-position: center;`:""}\n    }\n    .progress-bar-outer {\n      border: 1px solid currentColor;\n      height: 10px;\n      width: 200px;\n      max-width: 200px;\n    }\n    .progress-bar-inner {\n      height: 100%;\n      width: 0;\n      background-color: currentColor;\n    }\n    .loading-text {\n      font-weight: normal;\n      font-size: 36px;\n      margin: 0 0 16px;\n    }\n    .loading-image {\n      margin: 0 0 16px;\n    }\n    #error-message, #error-stack {\n      font-family: monospace;\n      max-width: 600px;\n      white-space: pre-wrap;\n      user-select: text;\n      -webkit-user-select: text;\n    }\n    #error-stack {\n      text-align: left;\n      max-height: 200px;\n      overflow: auto;\n    }\n    .control-button {\n      width: 2rem;\n      height: 2rem;\n      padding: 0.375rem;\n      border-radius: 0.25rem;\n      margin-top: 0.5rem;\n      margin-bottom: 0.5rem;\n      user-select: none;\n      -webkit-user-select: none;\n      cursor: pointer;\n      border: 0;\n      border-radius: 4px;\n    }\n    .control-button:hover {\n      background: ${this.options.appearance.accent}26;\n    }\n    .control-button.active {\n      background: ${this.options.appearance.accent}59;\n    }\n    .fullscreen-button {\n      background: white !important;\n    }\n    .standalone-fullscreen-button {\n      position: absolute;\n      top: 0;\n      right: 0;\n      background-color: rgba(0, 0, 0, 0.5);\n      border-radius: 0 0 0 4px;\n      padding: 4px;\n      cursor: pointer;\n    }\n    .sc-canvas {\n      cursor: ${await this.generateCursor()};\n    }\n    ${this.options.custom.css}\n  </style>\n  <meta name="theme-color" content="${this.options.appearance.background}">\n  ${await this.generateFavicon()}\n</head>\n<body>\n  <noscript>Enable JavaScript</noscript>\n\n  <div id="app"></div>\n\n  <div id="launch" class="screen" hidden title="Click to start">\n    <div class="green-flag">\n      <svg viewBox="0 0 16.63 17.5" width="42" height="44">\n        <defs><style>.cls-1,.cls-2{fill:#4cbf56;stroke:#45993d;stroke-linecap:round;stroke-linejoin:round;}.cls-2{stroke-width:1.5px;}</style></defs>\n        <path class="cls-1" d="M.75,2A6.44,6.44,0,0,1,8.44,2h0a6.44,6.44,0,0,0,7.69,0V12.4a6.44,6.44,0,0,1-7.69,0h0a6.44,6.44,0,0,0-7.69,0"/>\n        <line class="cls-2" x1="0.75" y1="16.75" x2="0.75" y2="0.75"/>\n      </svg>\n    </div>\n  </div>\n\n  <div id="loading" class="screen">\n    ${this.options.loadingScreen.text?`<h1 class="loading-text">${d(this.options.loadingScreen.text)}</h1>`:""}\n    ${this.options.loadingScreen.image&&"normal"===this.options.loadingScreen.imageMode?`<div class="loading-image"><img src="${await C.adapter.readAsURL(this.options.loadingScreen.image,"loading-screen")}"></div>`:""}\n    ${this.options.loadingScreen.progressBar?'<div class="progress-bar-outer"><div class="progress-bar-inner" id="loading-inner"></div></div>':""}\n  </div>\n\n  <div id="error" class="screen" hidden>\n    <h1>Error</h1>\n    <details>\n      <summary id="error-message"></summary>\n      <p id="error-stack"></p>\n    </details>\n  </div>\n\n  ${"html"===this.options.target?`<script>${this.script}<\/script>`:'<script src="../script.js"><\/script>'}\n  <script>${t=`\n    const appElement = document.getElementById('app');\n    const launchScreen = document.getElementById('launch');\n    const loadingScreen = document.getElementById('loading');\n    const loadingInner = document.getElementById('loading-inner');\n    const errorScreen = document.getElementById('error');\n    const errorScreenMessage = document.getElementById('error-message');\n    const errorScreenStack = document.getElementById('error-stack');\n\n    const handleError = (error) => {\n      console.error(error);\n      if (!errorScreen.hidden) return;\n      errorScreen.hidden = false;\n      errorScreenMessage.textContent = '' + error;\n      let debug = error && error.stack || 'no stack';\n      debug += '\\nUser agent: ' + navigator.userAgent;\n      errorScreenStack.textContent = debug;\n    };\n    const setProgress = (progress) => {\n      if (loadingInner) loadingInner.style.width = progress * 100 + '%';\n    };\n    const interpolate = (a, b, t) => a + t * (b - a);\n\n    try {\n      setProgress(0.1);\n\n      const scaffolding = new Scaffolding.Scaffolding();\n      scaffolding.width = ${this.options.stageWidth};\n      scaffolding.height = ${this.options.stageHeight};\n      scaffolding.resizeMode = ${JSON.stringify(this.options.resizeMode)};\n      scaffolding.editableLists = ${this.options.monitors.editableLists};\n      scaffolding.setup();\n      scaffolding.appendTo(appElement);\n\n      const vm = scaffolding.vm;\n      window.scaffolding = scaffolding;\n      window.vm = scaffolding.vm;\n      window.Scratch = {\n        vm,\n        renderer: vm.renderer,\n        audioEngine: vm.runtime.audioEngine,\n        bitmapAdapter: vm.runtime.v2BitmapAdapter,\n        videoProvider: vm.runtime.ioDevices.video.provider\n      };\n\n      scaffolding.setUsername(${JSON.stringify(this.options.username)}.replace(/#/g, () => Math.floor(Math.random() * 10)));\n      scaffolding.setAccentColor(${JSON.stringify(this.options.appearance.accent)});\n\n      ${"ws"===this.options.cloudVariables.mode?`scaffolding.addCloudProvider(${this.makeWebSocketProvider()})`:"local"===this.options.cloudVariables.mode?`scaffolding.addCloudProvider(${this.makeLocalStorageProvider()})`:"custom"===this.options.cloudVariables.mode?this.makeCustomProvider():""};\n\n      ${this.options.controls.greenFlag.enabled?'\n      const greenFlagButton = document.createElement(\'img\');\n      greenFlagButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16.63 17.5"><path d="M.75 2a6.44 6.44 0 017.69 0h0a6.44 6.44 0 007.69 0v10.4a6.44 6.44 0 01-7.69 0h0a6.44 6.44 0 00-7.69 0" fill="#4cbf56" stroke="#45993d" stroke-linecap="round" stroke-linejoin="round"/><path stroke-width="1.5" fill="#4cbf56" stroke="#45993d" stroke-linecap="round" stroke-linejoin="round" d="M.75 16.75v-16"/></svg>\');\n      greenFlagButton.className = \'control-button\';\n      greenFlagButton.addEventListener(\'click\', () => {\n        scaffolding.greenFlag();\n      });\n      scaffolding.addEventListener(\'PROJECT_RUN_START\', () => {\n        greenFlagButton.classList.add(\'active\');\n      });\n      scaffolding.addEventListener(\'PROJECT_RUN_STOP\', () => {\n        greenFlagButton.classList.remove(\'active\');\n      });\n      scaffolding.addControlButton({\n        element: greenFlagButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.pause.enabled?'\n      const pauseButton = document.createElement(\'img\');\n      pauseButton.className = \'control-button\';\n      let isPaused = false;\n      pauseButton.addEventListener(\'click\', () => {\n        isPaused = !isPaused;\n        vm.setPaused(isPaused);\n      });\n      const updatePause = () => {\n        if (isPaused) {\n          pauseButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg width="16" height="16" viewBox="0 0 4.2333332 4.2333335" xmlns="http://www.w3.org/2000/svg"><path d="m3.95163484 2.02835365-1.66643921.9621191-1.66643913.96211911V.10411543l1.66643922.9621191z" fill="#ffae00"/></svg>\');\n        } else {\n          pauseButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg width="16" height="16" viewBox="0 0 4.2333332 4.2333335" xmlns="http://www.w3.org/2000/svg"><g fill="#ffae00"><path d="M.389.19239126h1.2631972v3.8485508H.389zM2.5810001.19239126h1.2631972v3.8485508H2.5810001z"/></g></svg>\');\n        }\n      }\n      vm.on(\'P4_PAUSE\', updatePause);\n      updatePause();\n      scaffolding.addControlButton({\n        element: pauseButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.stopAll.enabled?'\n      const stopAllButton = document.createElement(\'img\');\n      stopAllButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14"><path fill="#ec5959" stroke="#b84848" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M4.3.5h5.4l3.8 3.8v5.4l-3.8 3.8H4.3L.5 9.7V4.3z"/></svg>\');\n      stopAllButton.className = \'control-button\';\n      stopAllButton.addEventListener(\'click\', () => {\n        scaffolding.stopAll();\n      });\n      scaffolding.addControlButton({\n        element: stopAllButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.fullscreen.enabled?`\n      if (document.fullscreenEnabled || document.webkitFullscreenEnabled) {\n        let isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);\n        const fullscreenButton = document.createElement('img');\n        fullscreenButton.className = 'control-button fullscreen-button';\n        fullscreenButton.addEventListener('click', () => {\n          if (isFullScreen) {\n            if (document.exitFullscreen) {\n              document.exitFullscreen();\n            } else if (document.webkitExitFullscreen) {\n              document.webkitExitFullscreen();\n            }\n          } else {\n            if (document.body.requestFullscreen) {\n              document.body.requestFullscreen();\n            } else if (document.body.webkitRequestFullscreen) {\n              document.body.webkitRequestFullscreen();\n            }\n          }\n        });\n        const otherControlsExist = ${this.options.controls.greenFlag.enabled||this.options.controls.stopAll.enabled};\n        const fillColor = otherControlsExist ? '#575E75' : '${this.options.appearance.foreground}';\n        const updateFullScreen = () => {\n          isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);\n          document.body.classList.toggle('is-fullscreen', isFullScreen);\n          if (isFullScreen) {\n            fullscreenButton.src = 'data:image/svg+xml,' + encodeURIComponent('<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g fill="' + fillColor + '" fill-rule="evenodd"><path d="M12.662 3.65l.89.891 3.133-2.374a.815.815 0 011.15.165.819.819 0 010 .986L15.467 6.46l.867.871c.25.25.072.664-.269.664L12.388 8A.397.397 0 0112 7.611V3.92c0-.341.418-.514.662-.27M7.338 16.35l-.89-.89-3.133 2.374a.817.817 0 01-1.15-.166.819.819 0 010-.985l2.37-3.143-.87-.871a.387.387 0 01.27-.664L7.612 12a.397.397 0 01.388.389v3.692a.387.387 0 01-.662.27M7.338 3.65l-.89.891-3.133-2.374a.815.815 0 00-1.15.165.819.819 0 000 .986l2.37 3.142-.87.871a.387.387 0 00.27.664L7.612 8A.397.397 0 008 7.611V3.92a.387.387 0 00-.662-.27M12.662 16.35l.89-.89 3.133 2.374a.817.817 0 001.15-.166.819.819 0 000-.985l-2.368-3.143.867-.871a.387.387 0 00-.269-.664L12.388 12a.397.397 0 00-.388.389v3.692c0 .342.418.514.662.27"/></g></svg>');\n          } else {\n            fullscreenButton.src = 'data:image/svg+xml,' + encodeURIComponent('<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g fill="' + fillColor + '" fill-rule="evenodd"><path d="M16.338 7.35l-.89-.891-3.133 2.374a.815.815 0 01-1.15-.165.819.819 0 010-.986l2.368-3.142-.867-.871a.387.387 0 01.269-.664L16.612 3a.397.397 0 01.388.389V7.08a.387.387 0 01-.662.27M3.662 12.65l.89.89 3.133-2.374a.817.817 0 011.15.166.819.819 0 010 .985l-2.37 3.143.87.871c.248.25.071.664-.27.664L3.388 17A.397.397 0 013 16.611V12.92c0-.342.418-.514.662-.27M3.662 7.35l.89-.891 3.133 2.374a.815.815 0 001.15-.165.819.819 0 000-.986L6.465 4.54l.87-.871a.387.387 0 00-.27-.664L3.388 3A.397.397 0 003 3.389V7.08c0 .341.418.514.662.27M16.338 12.65l-.89.89-3.133-2.374a.817.817 0 00-1.15.166.819.819 0 000 .985l2.368 3.143-.867.871a.387.387 0 00.269.664l3.677.005a.397.397 0 00.388-.389V12.92a.387.387 0 00-.662-.27"/></g></svg>');\n          }\n        };\n        updateFullScreen();\n        document.addEventListener('fullscreenchange', updateFullScreen);\n        document.addEventListener('webkitfullscreenchange', updateFullScreen);\n        if (otherControlsExist) {\n          fullscreenButton.className = 'control-button fullscreen-button';\n          scaffolding.addControlButton({\n            element: fullscreenButton,\n            where: 'top-right'\n          });\n        } else {\n          fullscreenButton.className = 'standalone-fullscreen-button';\n          document.body.appendChild(fullscreenButton);\n        }\n      }`:""}\n\n      vm.setTurboMode(${this.options.turbo});\n      if (vm.setInterpolation) vm.setInterpolation(${this.options.interpolation});\n      if (vm.setFramerate) vm.setFramerate(${this.options.framerate});\n      if (vm.renderer.setUseHighQualityRender) vm.renderer.setUseHighQualityRender(${this.options.highQualityPen});\n      if (vm.setRuntimeOptions) vm.setRuntimeOptions({\n        fencing: ${this.options.fencing},\n        miscLimits: ${this.options.miscLimits},\n        maxClones: ${this.options.maxClones},\n      });\n      if (vm.setCompilerOptions) vm.setCompilerOptions({\n        enabled: ${this.options.compiler.enabled},\n        warpTimer: ${this.options.compiler.warpTimer}\n      });\n\n      if (typeof ScaffoldingAddons !== 'undefined') {\n        ScaffoldingAddons.run(scaffolding, ${JSON.stringify(this.getAddonOptions())});\n      }\n\n      for (const extension of ${JSON.stringify(this.options.extensions.map(e=>e.url))}) {\n        vm.extensionManager.loadExtensionURL(extension);\n      }\n\n      ${this.options.target.startsWith("nwjs-")?"\n      if (typeof nw !== 'undefined') {\n        const win = nw.Window.get();\n        win.on('new-win-policy', (frame, url, policy) => {\n          policy.ignore();\n          nw.Shell.openExternal(url);\n        });\n        win.on('navigation', (frame, url, policy) => {\n          policy.ignore();\n          nw.Shell.openExternal(url);\n        });\n        document.addEventListener('keydown', (e) => {\n          if (e.key === 'Escape' && document.fullscreenElement) {\n            document.exitFullscreen();\n          }\n        });\n      }":""}\n    } catch (e) {\n      handleError(e);\n    }\n  `,t.split("\n").filter((e,t,n)=>0===t||t===n.length-1||0!==e.trim().length||0!==n[t-1].trim().length).join("\n")}<\/script>\n  <script>${this.options.custom.js}<\/script>\n  ${await this.generateGetProjectData()}\n  <script>\n    const run = async () => {\n      const projectData = await getProjectData();\n      await scaffolding.loadProject(projectData);\n      setProgress(1);\n      loadingScreen.hidden = true;\n      if (${this.options.autoplay}) {\n        scaffolding.start();\n      } else {\n        launchScreen.hidden = false;\n        launchScreen.addEventListener('click', () => {\n          launchScreen.hidden = true;\n          scaffolding.start();\n        });\n        launchScreen.focus();\n      }\n    };\n    run().catch(handleError);\n  <\/script>\n</body>\n</html>\n`;var t;if(this.ensureNotAborted(),"html"!==this.options.target){let t;if("sb3"===this.project.type&&"zip-one-asset"!==this.options.target){t=await(await A()).loadAsync(this.project.arrayBuffer);for(const e of Object.keys(t.files))t.files["assets/"+e]=t.files[e],delete t.files[e]}else t=new(await A()),t.file("project.zip",this.project.arrayBuffer);return t.file("index.html",e),this.options.target.startsWith("nwjs-")?t=await this.addNwJS(t):this.options.target.startsWith("electron-")?t=await this.addElectron(t):"webview-mac"===this.options.target&&(t=await this.addWebViewMac(t)),this.ensureNotAborted(),{data:await t.generateAsync({type:"arraybuffer",compression:"DEFLATE",platform:"UNIX"},e=>{this.dispatchEvent(new r("zip-progress",{detail:{progress:e.percent/100}}))}),type:"application/zip",filename:this.generateFilename("zip")}}return{data:e,type:"text/html",filename:this.generateFilename("html")}}}C.adapter=null,C.getDefaultPackageNameFromFileName=e=>(e=(e=(e=(e=e.split(".")[0]).replace(/[^\-a-z ]/gi,"")).trim()).replace(/ /g,"-")).toLowerCase()||"packaged-project",C.getWindowTitleFromFileName=e=>(e=(e=e.trim()).split(".")[0])||"Packaged Project",C.DEFAULT_OPTIONS=()=>({turbo:!1,interpolation:!1,framerate:30,highQualityPen:!1,maxClones:300,fencing:!0,miscLimits:!0,stageWidth:480,stageHeight:360,resizeMode:"preserve-ratio",autoplay:!1,username:"player####",projectId:"",custom:{css:"",js:""},appearance:{background:"#000000",foreground:"#ffffff",accent:S.ACCENT_COLOR},loadingScreen:{progressBar:!0,text:"",imageMode:"normal",image:null},controls:{greenFlag:{enabled:!1},stopAll:{enabled:!1},fullscreen:{enabled:!1},pause:{enabled:!1}},monitors:{editableLists:!1},compiler:{enabled:!0,warpTimer:!1},target:"html",app:{icon:null,packageName:C.getDefaultPackageNameFromFileName(""),windowTitle:C.getWindowTitleFromFileName(""),windowMode:"window"},chunks:{gamepad:!1,pointerlock:!1},cloudVariables:{mode:"ws",cloudHost:"wss://clouddata.turbowarp.org",custom:{},specialCloudBehaviors:!1,unsafeCloudBehaviors:!1},cursor:{type:"auto",custom:null},extensions:[]});var L=C,j=n(3),k=n.n(j),P=n(1),B=n.n(P);const $="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#%()*+,-./:;=?@[]^_`{|}~",F=e=>{e>1309&&e++;let t="";for(;e>=0;)t=$[e%$.length]+t,e=Math.floor(e/$.length)-1;return t};class M{constructor(){this.generatedIds=new Map,this.references=new Map}addReference(e){const t=this.references.get(e)||0;this.references.set(e,t+1)}generateNewIds(){const e=Array.from(this.references.entries());e.sort((e,t)=>t[1]-e[1]);for(let t=0;t<e.length;t++)this.generatedIds.set(e[t][0],F(t))}getNewId(e){if(this.generatedIds.has(e))return this.generatedIds.get(e);throw new Error("getNewId called with unknown ID "+e)}}var D=e=>{const t=new M,n=new M;if(e.monitors)for(const n of e.monitors){const e=n.opcode;if("data_variable"===e||"data_listcontents"===e){const e=n.id;t.addReference(e)}}const s=e=>{const n=e[0];if(12===n||13===n){const n=e[2];t.addReference(n)}else if(11===n){const n=e[2];t.addReference(n)}};for(const o of e.targets){for(const e of Object.keys(o.variables))t.addReference(e);for(const e of Object.keys(o.lists))t.addReference(e);for(const e of Object.keys(o.broadcasts))t.addReference(e);for(const[e,r]of Object.entries(o.blocks))if(n.addReference(e),Array.isArray(r))s(r);else{r.parent&&n.addReference(r.parent),r.next&&n.addReference(r.next),r.fields.VARIABLE&&t.addReference(r.fields.VARIABLE[1]),r.fields.LIST&&t.addReference(r.fields.LIST[1]),r.fields.BROADCAST_OPTION&&t.addReference(r.fields.BROADCAST_OPTION[1]);for(const e of Object.values(r.inputs))for(let t=1;t<e.length;t++){const o=e[t];"string"==typeof o?n.addReference(o):Array.isArray(o)&&s(o)}}}if(t.generateNewIds(),n.generateNewIds(),e.monitors)for(const n of e.monitors){const e=n.opcode;if("data_variable"===e||"data_listcontents"===e){const e=n.id;n.id=t.getNewId(e)}n.value=Array.isArray(n.value)?[]:0}const o=e=>{const n=e[0];if(12===n||13===n){const n=e[2];e[2]=t.getNewId(n)}else if(11===n){const n=e[2];e[2]=t.getNewId(n)}};for(const s of e.targets){const e={},r={},i={},a={},c={};for(const[n,o]of Object.entries(s.variables))e[t.getNewId(n)]=o;for(const[e,n]of Object.entries(s.lists))r[t.getNewId(e)]=n;for(const[e,n]of Object.entries(s.broadcasts))i[t.getNewId(e)]=n;for(const[e,r]of Object.entries(s.blocks))if(a[n.getNewId(e)]=r,Array.isArray(r))o(r);else{r.parent&&(r.parent=n.getNewId(r.parent)),r.next&&(r.next=n.getNewId(r.next)),r.fields.VARIABLE&&(r.fields.VARIABLE[1]=t.getNewId(r.fields.VARIABLE[1])),r.fields.LIST&&(r.fields.LIST[1]=t.getNewId(r.fields.LIST[1])),r.fields.BROADCAST_OPTION&&(r.fields.BROADCAST_OPTION[1]=t.getNewId(r.fields.BROADCAST_OPTION[1]));for(const e of Object.values(r.inputs))for(let t=1;t<e.length;t++){const s=e[t];"string"==typeof s?e[t]=n.getNewId(s):Array.isArray(s)&&o(s)}r.shadow||delete r.shadow,r.topLevel||delete r.topLevel,delete r.x,delete r.y,delete r.comment}for(const[e,t]of Object.entries(s.comments)){const n=t.text;(n.includes(" // _twconfig_")||n.includes(" // _gamepad_"))&&(c[e]=t)}s.variables=e,s.lists=r,s.broadcasts=i,s.blocks=a,s.comments=c}return e.meta&&(delete e.meta.agent,delete e.meta.vm),e};const U="https://assets.scratch.mit.edu/internalapi/asset/$path/get/",W=e=>{const t=[];for(const n of e)if(Array.isArray(n))for(const e of n)t.push(e);else t.push(n);return t},_=e=>"targets"in e?"sb3":"objName"in e?"sb2":null,z=e=>{const t=(e.variables||[]).map(({name:e,isPersistent:t})=>({name:e,isCloud:t})),n=JSON.stringify(e);return{stageVariables:[],stageComments:[],usesMusic:!0,stageVariables:t,usesMusic:n.includes("drum:duration:elapsed:from:")||n.includes("playDrum")||n.includes("noteOn:duration:elapsed:from:")}},H=e=>{const t=e.targets[0];if(!t||!t.isStage)throw new Error("Project does not have stage");return{stageVariables:[],stageComments:[],usesMusic:!0,stageVariables:Object.values(t.variables).map(([e,t,n])=>({name:e,isCloud:!!n})),stageComments:Object.values(t.comments).map(e=>e.text),usesMusic:e.extensions.includes("music")}},V=e=>((e=>{const t=e.targets.find(e=>e.isStage);if(t)for(const e of Object.values(t.variables)){e[0].startsWith("☁")&&(e[2]=!0)}})(e),D(e),e),G=(e,t)=>{const n=["svg","png","jpg","jpeg","bmp"],s=["wav","mp3"],o=new k.a;let i=0,a=0;const c=e=>e.split(".")[1]||"",l=[e,...e.children.filter(e=>!e.listName&&!e.target)];return(e=>{const l=new Map,d=e=>(l.has(e)||l.set(e,(e=>{const t=c(e);return n.includes(t)?a++:s.includes(t)?i++:(console.warn("unknown extension: "+t),a++)})(e)),l.get(e));for(const t of e)t.md5&&(t.soundID=d(t.md5)),t.baseLayerMD5&&(t.baseLayerID=d(t.baseLayerMD5)),t.textLayerMD5&&(t.textLayerID=d(t.textLayerMD5));return Promise.all(Array.from(l.entries()).map(([e,n])=>((e,n)=>(t.dispatchEvent(new r("asset-fetch",{detail:e})),B()(U.replace("$path",e)).then(e=>e.arrayBuffer()).then(s=>{const i=`${n}.${c(e)}`;o.file(i,s),t.dispatchEvent(new r("asset-fetched",{detail:e}))})))(e,n)))})([...W(l.map(e=>e.costumes||[])),...W(l.map(e=>e.sounds||[]))]).then(()=>(o.file("project.json",JSON.stringify(e)),{zip:o,analysis:z(e)}))},J=(e,t)=>{const n=new k.a;n.file("project.json",JSON.stringify(V(e)));const s=e.targets,o=(e=>{const t=[],n=new Set;for(const s of e){const e=s.md5ext;n.has(e)||(n.add(e),t.push(s))}return t})([...W(s.map(e=>e.costumes||[])),...W(s.map(e=>e.sounds||[]))]);return Promise.all(o.map(e=>(e=>{const s=e.md5ext||e.assetId+"."+e.dataFormat;return t.dispatchEvent(new r("asset-fetch",{detail:s})),B()(U.replace("$path",s)).then(e=>e.arrayBuffer()).then(e=>{n.file(s,e),t.dispatchEvent(new r("asset-fetched",{detail:s}))})})(e))).then(()=>({zip:n,analysis:H(e)}))},q=async(e,t=(()=>{}))=>{let n,s,r;const i=new Uint8Array(e);if(i[0]==="{".charCodeAt(0)){const i=new o;let a,c=!1,l=0,d=0;const p=()=>{a||setTimeout(()=>{c||t("assets",l,d)})};i.addEventListener("asset-fetch",()=>{d++,p()}),i.addEventListener("asset-fetched",()=>{l++,p()});const u=(new TextDecoder).decode(e),f=JSON.parse(u);n=_(f);const h=await((e,t)=>{const n=_(e);if("sb3"===n)return J(e,t);if("sb2"===n)return G(e,t);throw new Error("Unknown project type")})(f,i);t("assets",d,d),c=!0,s=await h.zip.generateAsync({type:"arraybuffer",compression:"DEFLATE"},e=>{t("compress",e.percent/100)}),r=h.analysis}else if((e=>{for(let t=0;t<"ScratchV".length;t++)if(e[t]!=="ScratchV".charCodeAt(t))return!1;return!0})(i))s=e,r={stageVariables:[],stageComments:[],usesMusic:!0};else{let o;try{o=await k.a.loadAsync(e)}catch(e){throw new Error("Cannot parse project: not a zip or sb")}const i=o.file(/^([^/]*\/)?project\.json$/)[0];if(!i)throw new Error("project.json is missing");const a=i.name.substr(0,i.name.indexOf("project.json"));""!==a&&(o=o.folder(a));const c=await i.async("text"),l=JSON.parse(c);n=_(l),"sb3"===n?(o.file("project.json",JSON.stringify(V(l))),s=await o.generateAsync({type:"arraybuffer",compression:"DEFLATE"},e=>{t("compress",e.percent/100)}),r=H(l)):(s=e,r=z(l))}return"sb3"===n?{type:"sb3",arrayBuffer:s,analysis:r}:{type:"blob",arrayBuffer:s,analysis:r}};var Y=n(4),X=n.n(Y),Q=n(2),K=n.n(Q),Z=n(5),ee=n(7),te=n.p+"290e09e569a1cab8e61ba93b0d23863f.png";const ne=Object(Z.promisify)(X.a.readFile),se=Object(Z.promisify)(X.a.writeFile),oe=Object(Z.promisify)(X.a.mkdir),re=(e,t)=>{e=K.a.join(e,"/");const n=K.a.join(e,t);return n.startsWith(e)?n:null},ie=K.a.join(__dirname,"..",".packager-cache");var ae=class{async getCachedAsset(e){if(e.src.startsWith("scaffolding/")){const t=re(__dirname,e.src);if(t)return ne(t,"utf-8")}if(e.src.startsWith("https:")){const n=await(async e=>{if(!e.sha256)return null;const t=re(ie,e.sha256);return t?(await oe(ie,{recursive:!0}),t):null})(e);if(n)try{return(t=await ne(n)).buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}catch(e){}console.log(`[${ee.a}]: downloading large asset ${e.src}; this may take a while`);const s=await B()(e.src);if(!s.ok)throw new Error("Unexpected status code: "+s.status);const o=await s.arrayBuffer();return n&&await se(n,(e=>Buffer.from(e))(o)),o}var t}async cacheAsset(e,t){}async getAppIcon(e){const t=await ne(K.a.join(__dirname,te));return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}readAsURL(e){throw new Error("image features not implemented in Node.js module")}};L.adapter=new ae},function(e,t){e.exports=s},function(e,t){e.exports=require("buffer")}])}));
